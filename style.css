/* ═══════════════════════════════════════════════════════════════
   FAWN'S LIFE TRACKER - Main Extension Script
   Version: 1.0.0
   ═══════════════════════════════════════════════════════════════ */

import { extension_settings, getContext, saveSettingsDebounced } from "../../../extensions.js";
import { eventSource, event_types, saveSettings } from "../../../../script.js";

// Extension name constant
const extensionName = "fawns-life-tracker";
const extensionFolderPath = `scripts/extensions/third-party/${extensionName}`;

// Default settings
const defaultSettings = {
    enabled: true,
    autoInsert: false,
    lastUsedTracker: null
};

// Tracker templates configuration
const TRACKERS = {
    conception: {
        id: 'conception',
        name: 'Conception Roll',
        icon: 'fa-solid fa-dice',
        description: 'Pregnancy chance calculation',
        fields: [
            { id: 'roll', label: 'Roll Result', type: 'number', min: 1, max: 100, default: '' },
            { id: 'conception', label: 'Conception', type: 'select', options: ['Yes', 'No'], default: 'No' },
            { id: 'dueDate', label: 'Due Date', type: 'date', default: '' }
        ]
    },
    pregnancy: {
        id: 'pregnancy',
        name: 'Pregnancy Tracker',
        icon: 'fa-solid fa-person-pregnant',
        description: 'Track pregnancy progress & symptoms',
        fields: [
            { id: 'knowledge', label: 'Knowledge Status', type: 'select', options: ['Hidden', 'Disclosed'], default: 'Hidden' },
            { id: 'week', label: 'Current Week', type: 'number', min: 1, max: 42, default: '' },
            { id: 'size', label: 'Baby Size (fruit comparison)', type: 'text', default: '' },
            { id: 'dueDate', label: 'Due Date', type: 'date', default: '' },
            { id: 'gender', label: 'Gender', type: 'select', options: ['Unknown', 'Boy', 'Girl', 'Twins'], default: 'Unknown' },
            { id: 'symptoms', label: 'Current Symptoms', type: 'textarea', default: '' },
            { id: 'nextVisit', label: 'Next Checkup', type: 'text', default: '' },
            { id: 'risks', label: 'Risks/Concerns', type: 'text', default: 'Stable' }
        ]
    },
    birth: {
        id: 'birth',
        name: 'Birth Report',
        icon: 'fa-solid fa-baby-carriage',
        description: 'Newborn stats & genetics',
        fields: [
            { id: 'gender', label: 'Gender', type: 'select', options: ['Boy', 'Girl', 'Twins (Boys)', 'Twins (Girls)', 'Twins (Mixed)'], default: 'Boy' },
            { id: 'usAccuracy', label: 'Ultrasound Accuracy', type: 'select', options: ['Confirmed', 'Missed (Surprise!)'], default: 'Confirmed' },
            { id: 'weight', label: 'Weight (kg)', type: 'number', min: 1, max: 6, step: 0.1, default: '' },
            { id: 'height', label: 'Height (cm)', type: 'number', min: 40, max: 60, default: '' },
            { id: 'dominance', label: 'Genetic Dominance', type: 'text', default: '' },
            { id: 'features', label: 'Physical Features', type: 'textarea', default: '' },
            { id: 'temperament', label: 'Temperament Traits', type: 'text', default: '' },
            { id: 'health', label: 'Vital Health', type: 'select', options: ['Stable', 'Under Observation', 'Critical'], default: 'Stable' },
            { id: 'pathology', label: 'Pathology/Defects', type: 'text', default: 'None Detected' }
        ]
    },
    babyCare: {
        id: 'babyCare',
        name: 'Baby Care Monitor',
        icon: 'fa-solid fa-baby',
        description: 'Track baby needs & development',
        fields: [
            { id: 'name', label: 'Baby Name', type: 'text', default: '' },
            { id: 'age', label: 'Age', type: 'text', default: '' },
            { id: 'hunger', label: 'Hunger', type: 'select', options: ['Full', 'Satisfied', 'Hungry', 'Starving'], default: 'Full' },
            { id: 'hygiene', label: 'Hygiene', type: 'select', options: ['Clean', 'Needs Change', 'Soiled'], default: 'Clean' },
            { id: 'energy', label: 'Energy', type: 'select', options: ['Rested', 'Active', 'Tired', 'Exhausted'], default: 'Rested' },
            { id: 'mood', label: 'Mood', type: 'select', options: ['Happy', 'Content', 'Fussy', 'Crying', 'Sleeping'], default: 'Content' },
            { id: 'traits', label: 'Personality Traits', type: 'text', default: '' },
            { id: 'milestone', label: 'Next Milestone', type: 'text', default: '' },
            { id: 'medical', label: 'Next Medical Visit', type: 'text', default: '' },
            { id: 'immediateNeed', label: 'Immediate Need', type: 'text', default: 'None' }
        ]
    }
};

// Chat-specific data storage
let chatTrackerData = {};
let undoHistory = [];

/* ═══════════════════════════════════════════════════════════════
   INITIALIZATION
   ═══════════════════════════════════════════════════════════════ */

jQuery(async () => {
    // Initialize settings
    if (!extension_settings[extensionName]) {
        extension_settings[extensionName] = Object.assign({}, defaultSettings);
    }

    // Load saved settings
    Object.assign(extension_settings[extensionName], defaultSettings, extension_settings[extensionName]);

    // Create UI elements
    createMainButton();
    createPopupMenu();
    createModalOverlay();

    // Load chat-specific data when chat changes
    eventSource.on(event_types.CHAT_CHANGED, loadChatData);

    // Also load on initial page load if chat exists
    setTimeout(loadChatData, 1000);

    console.log(`[${extensionName}] Extension loaded successfully!`);
});

/* ═══════════════════════════════════════════════════════════════
   UI CREATION FUNCTIONS
   ═══════════════════════════════════════════════════════════════ */

function createMainButton() {
    const sendForm = document.getElementById('send_form');
    if (!sendForm) {
        console.error(`[${extensionName}] Could not find send_form element`);
        return;
    }

    // Create button container for positioning
    const buttonContainer = document.createElement('div');
    buttonContainer.id = 'flt-button-container';
    buttonContainer.style.cssText = 'position: relative; display: inline-flex; align-items: center;';

    // Create main button
    const button = document.createElement('button');
    button.id = 'flt-main-button';
    button.type = 'button';
    button.innerHTML = `
        <i class="fa-solid fa-heart-pulse"></i>
        <span class="flt-btn-text">Trackers</span>
    `;
    button.title = "Fawn's Life Tracker";

    button.addEventListener('click', togglePopupMenu);

    buttonContainer.appendChild(button);

    // Insert before the send button
    const sendButton = sendForm.querySelector('#send_but') || sendForm.querySelector('button[type="submit"]');
    if (sendButton) {
        sendButton.parentNode.insertBefore(buttonContainer, sendButton);
    } else {
        sendForm.insertBefore(buttonContainer, sendForm.firstChild);
    }
}

function createPopupMenu() {
    const container = document.getElementById('flt-button-container');
    if (!container) return;

    const menu = document.createElement('div');
    menu.id = 'flt-popup-menu';
    menu.innerHTML = `
        <div class="flt-menu-header">
            <span class="flt-menu-title">
                <i class="fa-solid fa-heart-pulse"></i>
                Fawn's Life Tracker
            </span>
            <button class="flt-menu-close" onclick="document.getElementById('flt-popup-menu').classList.remove('show')">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div class="flt-tracker-list" id="flt-tracker-list">
            ${generateTrackerListHTML()}
        </div>
        <div class="flt-undo-section" id="flt-undo-section">
            <button class="flt-undo-btn" id="flt-undo-btn">
                <i class="fa-solid fa-rotate-left"></i>
                Undo Last Insert
            </button>
        </div>
    `;

    container.appendChild(menu);

    // Add event listeners to tracker items
    menu.querySelectorAll('.flt-tracker-item').forEach(item => {
        item.addEventListener('click', () => openTrackerModal(item.dataset.tracker));
    });

    // Undo button listener
    document.getElementById('flt-undo-btn')?.addEventListener('click', undoLastInsert);

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
        const menu = document.getElementById('flt-popup-menu');
        const button = document.getElementById('flt-main-button');
        if (menu && !menu.contains(e.target) && !button.contains(e.target)) {
            menu.classList.remove('show');
            button.classList.remove('active');
        }
    });
}

function generateTrackerListHTML() {
    return Object.values(TRACKERS).map(tracker => {
        const hasData = chatTrackerData[tracker.id];
        return `
            <div class="flt-tracker-item ${hasData ? 'active' : ''}" data-tracker="${tracker.id}">
                <div class="flt-tracker-icon">
                    <i class="${tracker.icon}"></i>
                </div>
                <div class="flt-tracker-info">
                    <div class="flt-tracker-name">${tracker.name}</div>
                    <div class="flt-tracker-desc">${tracker.description}</div>
                    ${hasData ? `<div class="flt-tracker-data">Data saved</div>` : ''}
                </div>
                <span class="flt-tracker-status ${hasData ? '' : 'inactive'}">
                    ${hasData ? 'Active' : 'Empty'}
                </span>
            </div>
        `;
    }).join('');
}

function createModalOverlay() {
    const overlay = document.createElement('div');
    overlay.className = 'flt-modal-overlay';
    overlay.id = 'flt-modal-overlay';
    overlay.innerHTML = `
        <div class="flt-modal" id="flt-modal">
            <div class="flt-modal-header">
                <span class="flt-modal-title" id="flt-modal-title">
                    <i class="fa-solid fa-edit"></i>
                    Edit Tracker
                </span>
                <button class="flt-menu-close" onclick="closeTrackerModal()">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="flt-modal-body" id="flt-modal-body">
                <!-- Dynamic content -->
            </div>
            <div class="flt-modal-footer">
                <button class="flt-btn flt-btn-secondary" onclick="closeTrackerModal()">
                    <i class="fa-solid fa-xmark"></i> Cancel
                </button>
                <button class="flt-btn flt-btn-ai" id="flt-btn-ai-fill">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Let AI Fill
                </button>
                <button class="flt-btn flt-btn-primary" id="flt-btn-apply">
                    <i class="fa-solid fa-check"></i> Apply
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(overlay);

    // Close on overlay click
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
            closeTrackerModal();
        }
    });

    // Make closeTrackerModal globally available
    window.closeTrackerModal = closeTrackerModal;
}

/* ═══════════════════════════════════════════════════════════════
   MENU & MODAL FUNCTIONS
   ═══════════════════════════════════════════════════════════════ */

function togglePopupMenu() {
    const menu = document.getElementById('flt-popup-menu');
    const button = document.getElementById('flt-main-button');

    if (menu.classList.contains('show')) {
        menu.classList.remove('show');
        button.classList.remove('active');
    } else {
        // Refresh tracker list to show current data status
        document.getElementById('flt-tracker-list').innerHTML = generateTrackerListHTML();

        // Re-add event listeners
        menu.querySelectorAll('.flt-tracker-item').forEach(item => {
            item.addEventListener('click', () => openTrackerModal(item.dataset.tracker));
        });

        // Update undo section visibility
        const undoSection = document.getElementById('flt-undo-section');
        if (undoHistory.length > 0) {
            undoSection.classList.add('show');
        } else {
            undoSection.classList.remove('show');
        }

        menu.classList.add('show');
        button.classList.add('active');
    }
}

function openTrackerModal(trackerId) {
    const tracker = TRACKERS[trackerId];
    if (!tracker) return;

    const overlay = document.getElementById('flt-modal-overlay');
    const title = document.getElementById('flt-modal-title');
    const body = document.getElementById('flt-modal-body');

    // Set title
    title.innerHTML = `<i class="${tracker.icon}"></i> ${tracker.name}`;

    // Generate form fields
    const savedData = chatTrackerData[trackerId] || {};

    body.innerHTML = `
        <div class="flt-info-box">
            <i class="fa-solid fa-circle-info"></i>
            Fill in the fields manually or click "Let AI Fill" to send empty template for AI to populate.
        </div>

        <form id="flt-tracker-form" data-tracker="${trackerId}">
            ${tracker.fields.map(field => generateFieldHTML(field, savedData[field.id])).join('')}
        </form>

        <div class="flt-preview-box">
            <div class="flt-preview-title">
                <i class="fa-solid fa-eye"></i> Preview
            </div>
            <div id="flt-preview-content">
                ${generateTrackerHTML(trackerId, savedData)}
            </div>
        </div>
    `;

    // Add input listeners for live preview
    body.querySelectorAll('input, select, textarea').forEach(input => {
        input.addEventListener('input', () => updatePreview(trackerId));
        input.addEventListener('change', () => updatePreview(trackerId));
    });

    // Set up button handlers
    document.getElementById('flt-btn-apply').onclick = () => applyTracker(trackerId, false);
    document.getElementById('flt-btn-ai-fill').onclick = () => applyTracker(trackerId, true);

    // Close popup menu
    document.getElementById('flt-popup-menu').classList.remove('show');
    document.getElementById('flt-main-button').classList.remove('active');

    // Show modal
    overlay.classList.add('show');
}

function closeTrackerModal() {
    document.getElementById('flt-modal-overlay').classList.remove('show');
}

function generateFieldHTML(field, value = '') {
    const currentValue = value || field.default || '';

    let inputHTML = '';

    switch (field.type) {
        case 'select':
            inputHTML = `
                <select class="flt-form-select" id="flt-field-${field.id}" name="${field.id}">
                    ${field.options.map(opt =>
                        `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${opt}</option>`
                    ).join('')}
                </select>
            `;
            break;
        case 'textarea':
            inputHTML = `
                <textarea class="flt-form-textarea" id="flt-field-${field.id}" name="${field.id}"
                    placeholder="Enter ${field.label.toLowerCase()}...">${currentValue}</textarea>
            `;
            break;
        case 'number':
            inputHTML = `
                <input type="number" class="flt-form-input" id="flt-field-${field.id}" name="${field.id}"
                    value="${currentValue}"
                    ${field.min !== undefined ? `min="${field.min}"` : ''}
                    ${field.max !== undefined ? `max="${field.max}"` : ''}
                    ${field.step !== undefined ? `step="${field.step}"` : ''}
                    placeholder="${field.label}">
            `;
            break;
        case 'date':
            inputHTML = `
                <input type="date" class="flt-form-input" id="flt-field-${field.id}" name="${field.id}"
                    value="${currentValue}">
            `;
            break;
        default:
            inputHTML = `
                <input type="text" class="flt-form-input" id="flt-field-${field.id}" name="${field.id}"
                    value="${currentValue}" placeholder="Enter ${field.label.toLowerCase()}...">
            `;
    }

    return `
        <div class="flt-form-group">
            <label class="flt-form-label" for="flt-field-${field.id}">
                ${field.label}
            </label>
            ${inputHTML}
        </div>
    `;
}

function updatePreview(trackerId) {
    const form = document.getElementById('flt-tracker-form');
    const formData = new FormData(form);
    const data = {};

    for (const [key, value] of formData.entries()) {
        data[key] = value;
    }

    document.getElementById('flt-preview-content').innerHTML = generateTrackerHTML(trackerId, data);
}

/* ═══════════════════════════════════════════════════════════════
   TRACKER HTML GENERATORS
   ═══════════════════════════════════════════════════════════════ */

function generateTrackerHTML(trackerId, data) {
    switch (trackerId) {
        case 'conception':
            return generateConceptionHTML(data);
        case 'pregnancy':
            return generatePregnancyHTML(data);
        case 'birth':
            return generateBirthHTML(data);
        case 'babyCare':
            return generateBabyCareHTML(data);
        default:
            return '<p>Unknown tracker type</p>';
    }
}

function generateConceptionHTML(data) {
    const roll = data.roll || '[Roll]';
    const conception = data.conception || '[Result]';
    const dueDate = data.dueDate ? formatDate(data.dueDate) : '[Date]';

    return `
<div style="
    background: transparent;
    color: var(--SmartThemeBodyColor);
    font-family: 'Courier New', monospace;
    font-size: 0.85em;
    padding: 5px;
    margin-top: -15px;
    margin-bottom: 20px;
    text-align: center;
    letter-spacing: 1px;
    opacity: 0.9;
    border-bottom: 1px dashed var(--SmartThemeBorderColor);
">
    <span style="color: var(--SmartThemeBodyColor); opacity: 0.7;">
        <i class="fa-solid fa-dice"></i> ROLL:
    </span>
    <span style="color: var(--SmartThemeAccent); font-weight: bold;">
        ${roll}/100
    </span>

    <span style="margin: 0 8px; color: var(--SmartThemeBorderColor);">|</span>

    <span style="color: var(--SmartThemeBodyColor); opacity: 0.7;">
        <i class="fa-solid fa-baby"></i> CONCEPTION:
    </span>
    <span style="color: var(--SmartThemeQuoteColor); font-weight: bold;">
        ${conception}
    </span>

    <span style="margin: 0 8px; color: var(--SmartThemeBorderColor);">|</span>
    <span style="color: var(--SmartThemeAccent); font-weight: bold;">
        <i class="fa-regular fa-calendar-check"></i> DUE: ${dueDate}
    </span>
</div>`;
}

function generatePregnancyHTML(data) {
    return `
<div style="
    background: color-mix(in srgb, var(--SmartThemeBodyColor) 5%, transparent);
    border: 1px solid var(--SmartThemeBorderColor);
    border-radius: 6px;
    padding: 10px;
    margin-top: 5px;
    margin-bottom: 20px;
    font-family: 'Courier New', monospace;
    font-size: 0.85em;
    line-height: 1.5;
    color: var(--SmartThemeBodyColor);
">
    <div style="
        border-bottom: 1px dashed var(--SmartThemeBorderColor);
        margin-bottom: 4px;
        padding-bottom: 4px;
        font-weight: bold;
        color: var(--SmartThemeAccent);
        text-transform: uppercase;
        letter-spacing: 1px;
    ">
        <i class="fa-solid fa-person-pregnant"></i> Pregnancy Status
    </div>

    <div style="
        font-size: 0.75em;
        text-transform: uppercase;
        margin-bottom: 8px;
        color: var(--SmartThemeAccent);
        opacity: 0.8;
    ">
        <i class="fa-solid fa-eye${data.knowledge === 'Hidden' ? '-slash' : ''}"></i> Knowledge: <span style="font-weight: bold;">${data.knowledge || 'Hidden'}</span>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
        <div>
            <span style="opacity:0.7;"><i class="fa-regular fa-clock"></i> Week:</span>
            <strong style="color: var(--SmartThemeQuoteColor);">${data.week || '[Week]'}</strong>
        </div>
        <div>
            <span style="opacity:0.7;"><i class="fa-solid fa-apple-whole"></i> Size:</span>
            <strong style="color: var(--SmartThemeQuoteColor);">${data.size || '[Size]'}</strong>
        </div>
        <div>
            <span style="opacity:0.7;"><i class="fa-regular fa-calendar-check"></i> Due:</span>
            <strong style="color: var(--SmartThemeQuoteColor);">${data.dueDate ? formatDate(data.dueDate) : '[Date]'}</strong>
        </div>
        <div>
            <span style="opacity:0.7;"><i class="fa-solid fa-venus-mars"></i> Gender:</span>
            <strong style="color: var(--SmartThemeQuoteColor);">${data.gender || 'Unknown'}</strong>
        </div>
    </div>

    <div style="margin-top: 8px; border-top: 1px dotted var(--SmartThemeBorderColor); padding-top: 5px;">
        <div style="margin-bottom: 4px;">
            <span style="color: var(--SmartThemeAccent);"><i class="fa-solid fa-head-side-virus"></i> Symptoms:</span>
            <span style="opacity: 0.9;">${data.symptoms || '[Symptoms]'}</span>
        </div>
        <div style="margin-bottom: 4px;">
            <span style="color: var(--SmartThemeAccent);"><i class="fa-solid fa-user-doctor"></i> Next Visit:</span>
            <span style="opacity: 0.9;">${data.nextVisit || '[Next Visit]'}</span>
        </div>
        <div>
            <span style="color: #e76f51;"><i class="fa-solid fa-triangle-exclamation"></i> Risks:</span>
            <span style="opacity: 0.9; font-style: italic;">${data.risks || 'Stable'}</span>
        </div>
    </div>
</div>`;
}

function generateBirthHTML(data) {
    const timestamp = Date.now();

    return `
<div style="
    background: color-mix(in srgb, var(--SmartThemeBodyColor) 5%, transparent);
    border: 1px solid var(--SmartThemeBorderColor);
    border-radius: 8px;
    padding: 12px;
    margin-top: 5px;
    margin-bottom: 20px;
    font-family: 'Courier New', monospace;
    font-size: 0.85em;
    line-height: 1.5;
    color: var(--SmartThemeBodyColor);
    border-left: 4px solid var(--SmartThemeAccent);
">
    <div style="
        border-bottom: 1px dashed var(--SmartThemeBorderColor);
        margin-bottom: 6px;
        padding-bottom: 4px;
        font-weight: bold;
        color: var(--SmartThemeAccent);
        text-transform: uppercase;
        letter-spacing: 1.5px;
        display: flex;
        justify-content: space-between;
    ">
        <span><i class="fa-solid fa-baby-carriage"></i> Newborn Birth Report</span>
        <span style="font-size: 0.8em; opacity: 0.7;">FILE_REV_${timestamp}</span>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
        <div>
            <span style="opacity:0.7;"><i class="fa-solid fa-venus-mars"></i> Gender:</span>
            <strong style="color: var(--SmartThemeQuoteColor);">${data.gender || '[Gender]'}</strong>
        </div>
        <div>
            <span style="opacity:0.7;"><i class="fa-solid fa-circle-check"></i> US-Accuracy:</span>
            <strong style="color: var(--SmartThemeQuoteColor);">${data.usAccuracy || 'Confirmed'}</strong>
        </div>
        <div>
            <span style="opacity:0.7;"><i class="fa-solid fa-weight-scale"></i> Weight:</span>
            <strong style="color: var(--SmartThemeQuoteColor);">${data.weight ? data.weight + ' kg' : '[Weight]'}</strong>
        </div>
        <div>
            <span style="opacity:0.7;"><i class="fa-solid fa-ruler-vertical"></i> Height:</span>
            <strong style="color: var(--SmartThemeQuoteColor);">${data.height ? data.height + ' cm' : '[Height]'}</strong>
        </div>
    </div>

    <div style="margin-top: 10px; border-top: 1px solid var(--SmartThemeBorderColor); padding-top: 8px;">
        <div style="margin-bottom: 4px;">
            <span style="color: var(--SmartThemeAccent); font-weight: bold;"><i class="fa-solid fa-dna"></i> Genetics & Heritage:</span>
        </div>
        <div style="font-size: 0.9em; padding-left: 10px; border-left: 2px solid var(--SmartThemeBorderColor); margin-bottom: 8px;">
            <span style="opacity: 0.8;">Dominance:</span> <strong>${data.dominance || '[Dominance]'}</strong><br>
            <span style="opacity: 0.8;">Features:</span> ${data.features || '[Features]'}<br>
            <span style="opacity: 0.8;">Temperament:</span> ${data.temperament || '[Temperament]'}
        </div>
    </div>

    <div style="margin-top: 8px; background: rgba(0,0,0,0.15); padding: 8px; border-radius: 4px;">
        <div style="margin-bottom: 4px;">
            <span style="color: #2a9d8f;"><i class="fa-solid fa-heart-pulse"></i> Vital Health:</span>
            <span style="font-weight: bold; opacity: 0.9;">${data.health || 'Stable'}</span>
        </div>
        <div>
            <span style="color: #e76f51;"><i class="fa-solid fa-microscope"></i> Pathology/Defects:</span>
            <span style="opacity: 0.9; font-style: italic;">${data.pathology || 'None Detected'}</span>
        </div>
    </div>
</div>`;
}

function generateBabyCareHTML(data) {
    return `
<div style="
    background: color-mix(in srgb, var(--SmartThemeBodyColor) 5%, transparent);
    border: 1px solid var(--SmartThemeBorderColor);
    border-radius: 6px;
    padding: 10px;
    margin-top: 5px;
    margin-bottom: 20px;
    font-family: 'Courier New', monospace;
    font-size: 0.85em;
    line-height: 1.5;
    color: var(--SmartThemeBodyColor);
">
    <div style="
        border-bottom: 1px dashed var(--SmartThemeBorderColor);
        margin-bottom: 4px;
        padding-bottom: 4px;
        font-weight: bold;
        color: var(--SmartThemeAccent);
        text-transform: uppercase;
        letter-spacing: 1px;
    ">
        <i class="fa-solid fa-baby"></i> Baby Care Monitor
    </div>

    <div style="
        font-size: 0.75em;
        text-transform: uppercase;
        margin-bottom: 8px;
        color: var(--SmartThemeAccent);
        opacity: 0.8;
    ">
        <i class="fa-solid fa-id-card"></i> Name: <span style="font-weight: bold;">${data.name || '[Name]'}</span> | Age: <span style="font-weight: bold;">${data.age || '[Age]'}</span>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
        <div>
            <span style="opacity:0.7;"><i class="fa-solid fa-utensils"></i> Hunger:</span>
            <strong style="color: var(--SmartThemeQuoteColor);">${data.hunger || 'Full'}</strong>
        </div>
        <div>
            <span style="opacity:0.7;"><i class="fa-solid fa-soap"></i> Hygiene:</span>
            <strong style="color: var(--SmartThemeQuoteColor);">${data.hygiene || 'Clean'}</strong>
        </div>
        <div>
            <span style="opacity:0.7;"><i class="fa-solid fa-bed"></i> Energy:</span>
            <strong style="color: var(--SmartThemeQuoteColor);">${data.energy || 'Rested'}</strong>
        </div>
        <div>
            <span style="opacity:0.7;"><i class="fa-solid fa-face-smile"></i> Mood:</span>
            <strong style="color: var(--SmartThemeQuoteColor);">${data.mood || 'Content'}</strong>
        </div>
    </div>

    <div style="margin-top: 8px; border-top: 1px dotted var(--SmartThemeBorderColor); padding-top: 5px;">
        <div style="margin-bottom: 4px;">
            <span style="color: var(--SmartThemeAccent);"><i class="fa-solid fa-dna"></i> Traits:</span>
            <span style="opacity: 0.9;">${data.traits || '[Traits]'}</span>
        </div>
        <div style="margin-bottom: 4px;">
            <span style="color: var(--SmartThemeAccent);"><i class="fa-solid fa-star"></i> Milestone:</span>
            <span style="opacity: 0.9;">Next: ${data.milestone || '[Milestone]'}</span>
        </div>
        <div style="margin-bottom: 4px;">
            <span style="color: var(--SmartThemeAccent);"><i class="fa-solid fa-user-doctor"></i> Medical:</span>
            <span style="opacity: 0.9;">${data.medical || '[Medical]'}</span>
        </div>
        <div style="background: rgba(231, 111, 81, 0.1); padding: 3px; border-radius: 3px; margin-top: 5px;">
            <span style="color: #e76f51;"><i class="fa-solid fa-circle-exclamation"></i> Immediate Need:</span>
            <span style="opacity: 0.9; font-style: italic;">${data.immediateNeed || 'None'}</span>
        </div>
    </div>
</div>`;
}

/* ═══════════════════════════════════════════════════════════════
   DATA MANAGEMENT FUNCTIONS
   ═══════════════════════════════════════════════════════════════ */

function loadChatData() {
    const context = getContext();
    if (!context.chatId) {
        chatTrackerData = {};
        return;
    }

    const storageKey = `flt_data_${context.chatId}`;
    const saved = localStorage.getItem(storageKey);

    if (saved) {
        try {
            chatTrackerData = JSON.parse(saved);
        } catch (e) {
            console.error(`[${extensionName}] Error loading chat data:`, e);
            chatTrackerData = {};
        }
    } else {
        chatTrackerData = {};
    }

    console.log(`[${extensionName}] Loaded data for chat:`, context.chatId);
}

function saveChatData() {
    const context = getContext();
    if (!context.chatId) return;

    const storageKey = `flt_data_${context.chatId}`;
    localStorage.setItem(storageKey, JSON.stringify(chatTrackerData));

    console.log(`[${extensionName}] Saved data for chat:`, context.chatId);
}

function applyTracker(trackerId, letAiFill = false) {
    const form = document.getElementById('flt-tracker-form');
    const formData = new FormData(form);
    const data = {};

    for (const [key, value] of formData.entries()) {
        data[key] = value;
    }

    // If AI fill, clear all data to show placeholders
    if (letAiFill) {
        Object.keys(data).forEach(key => {
            data[key] = '';
        });
    }

    // Save to chat data
    chatTrackerData[trackerId] = data;
    saveChatData();

    // Generate HTML
    const html = generateTrackerHTML(trackerId, data);

    // Get textarea and insert
    const textarea = document.getElementById('send_textarea');
    if (textarea) {
        // Save current content for undo
        undoHistory.push({
            trackerId: trackerId,
            previousContent: textarea.value,
            timestamp: Date.now()
        });

        // Keep only last 10 undos
        if (undoHistory.length > 10) {
            undoHistory.shift();
        }

        // Add HTML to end of message
        const currentText = textarea.value;
        const newText = currentText + (currentText ? '\n\n' : '') + html;
        textarea.value = newText;

        // Trigger input event for SillyTavern to recognize the change
        textarea.dispatchEvent(new Event('input', { bubbles: true }));
    }

    // Close modal
    closeTrackerModal();

    // Show success toast
    showToast(`${TRACKERS[trackerId].name} ${letAiFill ? 'template' : 'data'} inserted!`, 'success');
}

function undoLastInsert() {
    if (undoHistory.length === 0) {
        showToast('Nothing to undo', 'error');
        return;
    }

    const lastAction = undoHistory.pop();
    const textarea = document.getElementById('send_textarea');

    if (textarea) {
        textarea.value = lastAction.previousContent;
        textarea.dispatchEvent(new Event('input', { bubbles: true }));
    }

    // Update undo section visibility
    const undoSection = document.getElementById('flt-undo-section');
    if (undoHistory.length === 0) {
        undoSection.classList.remove('show');
    }

    showToast('Undone!', 'success');
}

/* ═══════════════════════════════════════════════════════════════
   UTILITY FUNCTIONS
   ═══════════════════════════════════════════════════════════════ */

function formatDate(dateString) {
    if (!dateString) return '[Date]';

    try {
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = String(date.getFullYear()).slice(-2);
        return `${day}/${month}/${year}`;
    } catch (e) {
        return dateString;
    }
}

function showToast(message, type = 'success') {
    // Remove existing toast
    const existingToast = document.querySelector('.flt-toast');
    if (existingToast) {
        existingToast.remove();
    }

    const toast = document.createElement('div');
    toast.className = `flt-toast ${type}`;
    toast.innerHTML = `
        <i class="fa-solid fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        <span>${message}</span>
    `;

    document.body.appendChild(toast);

    // Auto remove after 3 seconds
    setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

/* ═══════════════════════════════════════════════════════════════
   EXPORT FOR GLOBAL ACCESS
   ═══════════════════════════════════════════════════════════════ */

window.FawnsLifeTracker = {
    openTracker: openTrackerModal,
    getData: () => chatTrackerData,
    setData: (trackerId, data) => {
        chatTrackerData[trackerId] = data;
        saveChatData();
    },
    generateHTML: generateTrackerHTML
};
