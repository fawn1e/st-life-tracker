/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FAWN'S LIFE TRACKER - Main Extension Script
   Version: 3.0.0 - With Conception Monitoring & Miscarriage System
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

console.log("Fawn's Life Tracker: Initializing v3.0...");

import { extension_settings, getContext } from "../../../extensions.js";
import { eventSource, event_types } from "../../../../script.js";
import { setExtensionPrompt, extension_prompt_types, extension_prompt_roles } from "../../../../script.js";

const extensionName = "fawns-life-tracker";

// Default settings
const defaultSettings = {
    enabled: true,
    autoLaborEnabled: true,
    autoTransitionEnabled: true,
    autoOOCEnabled: true,
    miscarriageEnabled: true, // NEW
    miscarriageBaseChance: 3, // Base % in first trimester
    laborChanceBase: 15,
    laborChancePerWeek: 10
};

// Initialize settings
if (!extension_settings[extensionName]) {
    extension_settings[extensionName] = { ...defaultSettings };
}

// Tracker templates configuration
const TRACKERS = {
    conception: {
        id: 'conception',
        name: 'Conception Roll',
        icon: 'fa-solid fa-dice',
        description: 'Pregnancy chance calculation',
        color: '#9b59b6',
        fields: [
            { id: 'roll', label: 'Roll Result (1-100)', type: 'number', min: 1, max: 100, default: '' },
            { id: 'threshold', label: 'Success Threshold', type: 'number', min: 1, max: 100, default: 20 },
            { id: 'conception', label: 'Conception Result', type: 'select', options: ['Pending', 'Yes', 'No'], default: 'Pending' },
            { id: 'conceptionDate', label: 'Conception Date', type: 'date', default: '' },
            { id: 'dueDate', label: 'Due Date (auto-calculated)', type: 'date', default: '' }
        ]
    },
    pregnancy: {
        id: 'pregnancy',
        name: 'Pregnancy Tracker',
        icon: 'fa-solid fa-person-pregnant',
        description: 'Track pregnancy progress & symptoms',
        color: '#e91e63',
        fields: [
            { id: 'knowledge', label: 'Knowledge Status', type: 'select', options: ['Hidden', 'Suspected', 'Confirmed'], default: 'Hidden' },
            { id: 'week', label: 'Current Week', type: 'number', min: 1, max: 42, default: 1 },
            { id: 'size', label: 'Baby Size (fruit comparison)', type: 'text', default: '' },
            { id: 'dueDate', label: 'Due Date', type: 'date', default: '' },
            { id: 'gender', label: 'Gender', type: 'select', options: ['Unknown', 'Boy', 'Girl', 'Twins'], default: 'Unknown' },
            { id: 'symptoms', label: 'Current Symptoms', type: 'textarea', default: '' },
            { id: 'nextVisit', label: 'Next Checkup', type: 'text', default: '' },
            { id: 'risks', label: 'Risks/Concerns', type: 'select', options: ['Stable', 'Mild Concern', 'Moderate Risk', 'High Risk', 'Critical'], default: 'Stable' },
            { id: 'riskDetails', label: 'Risk Details', type: 'textarea', default: '' },
            { id: 'doctorAdvice', label: "Doctor's Advice", type: 'text', default: '' },
            { id: 'adviceFollowed', label: 'Advice Followed?', type: 'select', options: ['Yes', 'Partially', 'No', 'N/A'], default: 'N/A' }
        ]
    },
    birth: {
        id: 'birth',
        name: 'Birth Report',
        icon: 'fa-solid fa-baby-carriage',
        description: 'Newborn stats & genetics',
        color: '#2196f3',
        fields: [
            { id: 'babyName', label: 'Baby Name', type: 'text', default: '' },
            { id: 'gender', label: 'Gender', type: 'select', options: ['Boy', 'Girl', 'Twins (Boys)', 'Twins (Girls)', 'Twins (Mixed)'], default: 'Boy' },
            { id: 'usAccuracy', label: 'Ultrasound Accuracy', type: 'select', options: ['Confirmed', 'Missed (Surprise!)'], default: 'Confirmed' },
            { id: 'weight', label: 'Weight (kg)', type: 'text', default: '' },
            { id: 'height', label: 'Height (cm)', type: 'text', default: '' },
            { id: 'dominance', label: 'Genetic Dominance', type: 'text', default: '' },
            { id: 'features', label: 'Physical Features', type: 'textarea', default: '' },
            { id: 'temperament', label: 'Temperament Traits', type: 'text', default: '' },
            { id: 'health', label: 'Vital Health', type: 'select', options: ['Stable', 'Under Observation', 'Critical'], default: 'Stable' },
            { id: 'pathology', label: 'Pathology/Defects', type: 'text', default: 'None Detected' }
        ]
    },
    babyCare: {
        id: 'babyCare',
        name: 'Baby Care Monitor',
        icon: 'fa-solid fa-baby',
        description: 'Track baby needs & development',
        color: '#4caf50',
        fields: [
            { id: 'name', label: 'Baby Name', type: 'text', default: '' },
            { id: 'age', label: 'Age', type: 'text', default: '' },
            { id: 'hunger', label: 'Hunger', type: 'select', options: ['Full', 'Satisfied', 'Hungry', 'Starving'], default: 'Full' },
            { id: 'hygiene', label: 'Hygiene', type: 'select', options: ['Clean', 'Needs Change', 'Soiled'], default: 'Clean' },
            { id: 'energy', label: 'Energy', type: 'select', options: ['Rested', 'Active', 'Tired', 'Exhausted'], default: 'Rested' },
            { id: 'mood', label: 'Mood', type: 'select', options: ['Happy', 'Content', 'Fussy', 'Crying', 'Sleeping'], default: 'Content' },
            { id: 'traits', label: 'Personality Traits', type: 'text', default: '' },
            { id: 'milestone', label: 'Next Milestone', type: 'text', default: '' },
            { id: 'medical', label: 'Next Medical Visit', type: 'text', default: '' },
            { id: 'immediateNeed', label: 'Immediate Need', type: 'text', default: 'None' }
        ]
    },
    miscarriage: {
        id: 'miscarriage',
        name: 'Loss Report',
        icon: 'fa-solid fa-heart-crack',
        description: 'Pregnancy loss documentation',
        color: '#6c757d',
        fields: [
            { id: 'weekLost', label: 'Week of Loss', type: 'number', min: 1, max: 42, default: '' },
            { id: 'cause', label: 'Cause/Circumstances', type: 'select', options: ['Unknown/Natural', 'Medical Complications', 'Ignored Risks', 'Trauma/Accident', 'Health Condition'], default: 'Unknown/Natural' },
            { id: 'causeDetails', label: 'Details', type: 'textarea', default: '' },
            { id: 'medicalCare', label: 'Medical Care Received', type: 'select', options: ['Yes - Hospital', 'Yes - Home', 'No', 'Refused'], default: 'Yes - Hospital' },
            { id: 'physicalRecovery', label: 'Physical Recovery', type: 'select', options: ['Recovering', 'Stable', 'Complications'], default: 'Recovering' },
            { id: 'emotionalState', label: 'Emotional State', type: 'select', options: ['Devastated', 'Grieving', 'Numb', 'Coping', 'In Denial'], default: 'Grieving' },
            { id: 'support', label: 'Support System', type: 'text', default: '' },
            { id: 'notes', label: 'Additional Notes', type: 'textarea', default: '' }
        ]
    }
};

// Risk factors that increase miscarriage chance
const RISK_MULTIPLIERS = {
    'Stable': 1,
    'Mild Concern': 1.5,
    'Moderate Risk': 2.5,
    'High Risk': 4,
    'Critical': 6
};

// Keywords that indicate ignored medical advice
const IGNORED_ADVICE_KEYWORDS = [
    'ignored', 'refused', 'skipped', 'missed appointment', 'didn\'t take',
    'stopped medication', 'no rest', 'overworked', 'stress', 'drinking',
    'smoking', 'drugs', 'untreated', 'worsening', 'deteriorating'
];

// High risk keywords for labor
const HIGH_RISK_KEYWORDS = [
    'critical', 'severe', 'emergency', 'bleeding', 'contractions',
    'preterm', 'early labor', 'water broke', 'high blood pressure',
    'preeclampsia', 'placenta', 'distress', 'urgent', 'hospital'
];

// Baby size by week
const BABY_SIZES = {
    4: 'Poppy seed', 5: 'Sesame seed', 6: 'Lentil', 7: 'Blueberry',
    8: 'Kidney bean', 9: 'Grape', 10: 'Kumquat', 11: 'Fig',
    12: 'Lime', 13: 'Pea pod', 14: 'Lemon', 15: 'Apple',
    16: 'Avocado', 17: 'Turnip', 18: 'Bell pepper', 19: 'Heirloom tomato',
    20: 'Banana', 21: 'Carrot', 22: 'Spaghetti squash', 23: 'Large mango',
    24: 'Ear of corn', 25: 'Rutabaga', 26: 'Scallion', 27: 'Cauliflower',
    28: 'Eggplant', 29: 'Butternut squash', 30: 'Large cabbage', 31: 'Coconut',
    32: 'Jicama', 33: 'Pineapple', 34: 'Cantaloupe', 35: 'Honeydew melon',
    36: 'Romaine lettuce', 37: 'Swiss chard', 38: 'Leek', 39: 'Mini watermelon',
    40: 'Small pumpkin', 41: 'Watermelon', 42: 'Jackfruit'
};

// Chat-specific data storage
let chatTrackerData = {};
let activeTracker = null;
let undoHistory = [];
let activeOOC = null;
let pregnancyHistory = []; // Track risk progression

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OOC SYSTEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function generateConceptionOOC(conceptionData) {
    const lines = [];

    if (conceptionData.conception === 'Yes') {
        lines.push("CONCEPTION SUCCESS - CHARACTER IS NOW PREGNANT:");
        lines.push("");
        lines.push("The character has just conceived. This is very early - they likely don't know yet.");
        lines.push("");
        if (conceptionData.dueDate) {
            lines.push(`â€¢ Due Date: ${formatDate(conceptionData.dueDate)} (40 weeks from conception)`);
        }
        lines.push("");
        lines.push("EARLY SIGNS TO SUBTLY INCORPORATE (if appropriate for timeline):");
        lines.push("- Slight fatigue or unusual tiredness");
        lines.push("- Mild nausea or food aversions");
        lines.push("- Breast tenderness");
        lines.push("- Missed period (if enough time has passed)");
        lines.push("- Mood changes");
        lines.push("");
        lines.push("Don't reveal the pregnancy directly unless the character takes a test.");
        lines.push("Let the symptoms build naturally over time.");
    } else if (conceptionData.conception === 'No') {
        lines.push("CONCEPTION FAILED - Character did NOT conceive this time.");
        lines.push("Continue the story normally without pregnancy.");
    }

    return lines.join('\n');
}

function generatePregnancyOOC(pregnancyData) {
    const lines = [];
    const week = parseInt(pregnancyData.week) || 1;
    const trimester = week <= 12 ? 'First' : week <= 27 ? 'Second' : 'Third';

    lines.push(`PREGNANCY STATUS UPDATE - Week ${week} (${trimester} Trimester):`);
    lines.push("");

    if (pregnancyData.knowledge === 'Hidden') {
        lines.push("âš  CHARACTER DOESN'T KNOW THEY'RE PREGNANT YET");
        lines.push("Show symptoms subtly without revealing the cause.");
    } else if (pregnancyData.knowledge === 'Suspected') {
        lines.push("âš  CHARACTER SUSPECTS BUT ISN'T CONFIRMED");
        lines.push("Show growing suspicion and uncertainty.");
    }

    lines.push("");
    lines.push(`â€¢ Week: ${week}`);
    lines.push(`â€¢ Baby Size: ${pregnancyData.size || BABY_SIZES[week] || 'Unknown'}`);

    if (pregnancyData.gender !== 'Unknown') {
        lines.push(`â€¢ Gender: ${pregnancyData.gender}`);
    }

    if (pregnancyData.symptoms) {
        lines.push(`â€¢ Current Symptoms: ${pregnancyData.symptoms}`);
    }

    if (pregnancyData.risks !== 'Stable') {
        lines.push("");
        lines.push(`âš  RISK LEVEL: ${pregnancyData.risks}`);
        if (pregnancyData.riskDetails) {
            lines.push(`  Details: ${pregnancyData.riskDetails}`);
        }
        if (pregnancyData.doctorAdvice) {
            lines.push(`  Doctor's Advice: ${pregnancyData.doctorAdvice}`);
        }
        if (pregnancyData.adviceFollowed === 'No') {
            lines.push(`  âš  ADVICE IS BEING IGNORED - Show consequences!`);
        }
    }

    lines.push("");
    lines.push("Incorporate the pregnancy realistically into the scene.");

    return lines.join('\n');
}

function generateMiscarriageOOC(miscarriageData, pregnancyData) {
    const lines = [];

    lines.push("âš  PREGNANCY LOSS SCENE - Handle with sensitivity:");
    lines.push("");
    lines.push(`â€¢ Week of Loss: ${miscarriageData.weekLost || pregnancyData?.week || 'Unknown'}`);
    lines.push(`â€¢ Cause: ${miscarriageData.cause || 'Unknown/Natural'}`);

    if (miscarriageData.causeDetails) {
        lines.push(`â€¢ Details: ${miscarriageData.causeDetails}`);
    }

    lines.push("");
    lines.push("SCENE GUIDANCE:");
    lines.push("- Show the physical and emotional experience realistically");
    lines.push("- Include shock, denial, grief as appropriate");
    lines.push("- Consider medical intervention needs");
    lines.push("- Show support (or lack thereof) from others");
    lines.push("");
    lines.push(`Emotional State: ${miscarriageData.emotionalState || 'Grieving'}`);

    if (miscarriageData.support) {
        lines.push(`Support System: ${miscarriageData.support}`);
    }

    return lines.join('\n');
}

function generateBirthOOC(birthData) {
    const lines = [];

    lines.push("BIRTH SCENE INSTRUCTIONS - Use these EXACT details for the newborn:");
    lines.push("");

    if (birthData.babyName) {
        lines.push(`â€¢ Baby Name: ${birthData.babyName}`);
    }

    if (birthData.gender) {
        lines.push(`â€¢ Gender: ${birthData.gender}`);
        if (birthData.usAccuracy === 'Missed (Surprise!)') {
            lines.push(`  â†³ NOTE: This was a SURPRISE - ultrasound predicted differently!`);
        }
    }

    if (birthData.weight || birthData.height) {
        lines.push(`â€¢ Size: ${birthData.weight ? birthData.weight + ' kg' : ''}${birthData.weight && birthData.height ? ', ' : ''}${birthData.height ? birthData.height + ' cm' : ''}`);
    }

    if (birthData.dominance) {
        lines.push(`â€¢ Genetic Dominance: ${birthData.dominance}`);
    }

    if (birthData.features) {
        lines.push(`â€¢ Physical Features: ${birthData.features}`);
    }

    if (birthData.temperament) {
        lines.push(`â€¢ Temperament/Personality: ${birthData.temperament}`);
    }

    if (birthData.health && birthData.health !== 'Stable') {
        lines.push(`â€¢ Health Status: ${birthData.health} - incorporate medical attention if needed`);
    }

    if (birthData.pathology && birthData.pathology !== 'None Detected') {
        lines.push(`â€¢ Medical Notes: ${birthData.pathology}`);
    }

    lines.push("");
    lines.push("Write the birth scene incorporating ALL these specific details about the baby.");

    return lines.join('\n');
}

function generateLaborOOC(pregnancyData) {
    const lines = [];
    const week = pregnancyData.week || '??';
    const isPreterm = parseInt(week) < 37;

    lines.push("LABOR SCENE INSTRUCTIONS:");
    lines.push("");
    lines.push(`â€¢ Current Week: ${week} ${isPreterm ? '(PRETERM - this is early!)' : '(Full term)'}`);

    if (pregnancyData.gender && pregnancyData.gender !== 'Unknown') {
        lines.push(`â€¢ Expected Gender: ${pregnancyData.gender}`);
    }

    if (pregnancyData.risks && pregnancyData.risks !== 'Stable') {
        lines.push(`â€¢ Risk Factors: ${pregnancyData.risks}`);
        if (pregnancyData.riskDetails) {
            lines.push(`â€¢ Risk Details: ${pregnancyData.riskDetails}`);
        }
    }

    if (isPreterm) {
        lines.push("");
        lines.push("NOTE: This is a PRETERM labor. Show urgency and medical intervention.");
    }

    lines.push("");
    lines.push("Write the labor/delivery scene with realistic progression.");

    return lines.join('\n');
}

function generateBabyCareOOC(babyCareData) {
    const lines = [];

    lines.push("BABY CARE SCENE - Current status:");
    lines.push("");

    if (babyCareData.name) {
        lines.push(`â€¢ Baby: ${babyCareData.name} (${babyCareData.age || 'newborn'})`);
    }

    lines.push(`â€¢ Hunger: ${babyCareData.hunger || 'Unknown'}`);
    lines.push(`â€¢ Hygiene: ${babyCareData.hygiene || 'Unknown'}`);
    lines.push(`â€¢ Energy: ${babyCareData.energy || 'Unknown'}`);
    lines.push(`â€¢ Mood: ${babyCareData.mood || 'Unknown'}`);

    if (babyCareData.traits) {
        lines.push(`â€¢ Personality: ${babyCareData.traits}`);
    }

    if (babyCareData.immediateNeed && babyCareData.immediateNeed !== 'None') {
        lines.push("");
        lines.push(`âš  IMMEDIATE NEED: ${babyCareData.immediateNeed}`);
    }

    return lines.join('\n');
}

function sendTrackerOOC(trackerId, data, extraData = null) {
    if (!extension_settings[extensionName].autoOOCEnabled) return;

    let oocText = '';

    switch (trackerId) {
        case 'conception':
            oocText = generateConceptionOOC(data);
            break;
        case 'pregnancy':
            oocText = generatePregnancyOOC(data);
            break;
        case 'birth':
            oocText = generateBirthOOC(data);
            break;
        case 'babyCare':
            oocText = generateBabyCareOOC(data);
            break;
        case 'miscarriage':
            oocText = generateMiscarriageOOC(data, extraData);
            break;
        case 'labor':
            oocText = generateLaborOOC(data);
            break;
        default:
            return;
    }

    if (!oocText) return;

    const prompt = `[OOC INSTRUCTION FROM LIFE TRACKER]
${oocText}
[END OOC - incorporate these details naturally into your response]`;

    setExtensionPrompt(
        'fawn-life-tracker',
        prompt,
        extension_prompt_types.IN_CHAT,
        1,
        false,
        true,
        null,
        extension_prompt_roles.SYSTEM
    );

    activeOOC = { trackerId, data, timestamp: Date.now() };
    saveActiveOOC();

    console.log('FLT: OOC sent for', trackerId);
    updateMenuState();
}

function clearTrackerOOC() {
    setExtensionPrompt(
        'fawn-life-tracker',
        '',
        extension_prompt_types.IN_CHAT,
        1,
        false,
        true,
        null,
        extension_prompt_roles.SYSTEM
    );

    activeOOC = null;
    clearActiveOOCStorage();
    updateMenuState();
    console.log('FLT: OOC cleared');
}

function saveActiveOOC() {
    try {
        const chatId = getCurrentChatId();
        localStorage.setItem(`flt_ooc_${chatId}`, JSON.stringify(activeOOC));
    } catch (e) { }
}

function loadActiveOOC() {
    try {
        const chatId = getCurrentChatId();
        const saved = localStorage.getItem(`flt_ooc_${chatId}`);
        if (saved) {
            activeOOC = JSON.parse(saved);
            if (activeOOC && activeOOC.trackerId) {
                sendTrackerOOC(activeOOC.trackerId, activeOOC.data);
            }
        }
    } catch (e) { }
}

function clearActiveOOCStorage() {
    try {
        const chatId = getCurrentChatId();
        localStorage.removeItem(`flt_ooc_${chatId}`);
    } catch (e) { }
}

function hasActiveOOC() {
    return activeOOC !== null && activeOOC.trackerId;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONCEPTION SYSTEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function rollConception(threshold = 20) {
    const roll = Math.floor(Math.random() * 100) + 1;
    return {
        roll: roll,
        success: roll <= threshold
    };
}

function calculateDueDate(conceptionDate) {
    if (!conceptionDate) {
        conceptionDate = new Date();
    } else {
        conceptionDate = new Date(conceptionDate);
    }
    const dueDate = new Date(conceptionDate);
    dueDate.setDate(dueDate.getDate() + 280); // 40 weeks
    return dueDate.toISOString().split('T')[0];
}

function offerPregnancyTransition(conceptionData) {
    const isMobile = window.innerWidth <= 768;

    setTimeout(() => {
        const content = `
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 50px; margin-bottom: 15px;">
                    ğŸ¤°âœ¨
                </div>

                <div style="
                    color: var(--SmartThemeBodyColor);
                    font-size: ${isMobile ? '18px' : '16px'};
                    font-weight: bold;
                    margin-bottom: 10px;
                ">
                    Conception Successful!
                </div>

                <div style="
                    color: var(--SmartThemeBodyColor);
                    font-size: ${isMobile ? '14px' : '13px'};
                    opacity: 0.8;
                    margin-bottom: 20px;
                    line-height: 1.5;
                ">
                    Would you like to set up the Pregnancy Tracker?<br>
                    <small style="opacity: 0.7;">Due date: ${formatDate(conceptionData.dueDate)}</small>
                </div>

                <div style="
                    background: color-mix(in srgb, #2a9d8f 15%, transparent);
                    border: 1px solid #2a9d8f;
                    border-radius: 8px;
                    padding: 12px;
                    margin-bottom: 20px;
                    font-size: 12px;
                    color: var(--SmartThemeBodyColor);
                    text-align: left;
                ">
                    <i class="fa-solid fa-paper-plane" style="color: #2a9d8f;"></i>
                    <strong>OOC sent to AI!</strong><br>
                    <span style="opacity: 0.8; font-size: 11px;">AI will subtly incorporate early pregnancy signs.</span>
                </div>

                <div style="display: flex; gap: 10px; justify-content: center; ${isMobile ? 'flex-direction: column;' : ''}">
                    <button id="flt-pregnancy-yes" class="menu_button" style="
                        background: #e91e63;
                        color: white;
                        padding: ${isMobile ? '14px 24px' : '12px 24px'};
                        border-radius: 8px;
                        border: none;
                        font-size: ${isMobile ? '15px' : '14px'};
                        cursor: pointer;
                        ${isMobile ? 'width: 100%;' : ''}
                    ">
                        <i class="fa-solid fa-person-pregnant"></i> Set Up Tracker
                    </button>
                    <button id="flt-pregnancy-no" class="menu_button" style="
                        background: transparent;
                        color: var(--SmartThemeBodyColor);
                        padding: ${isMobile ? '14px 24px' : '12px 24px'};
                        border-radius: 8px;
                        border: 1px solid var(--SmartThemeBorderColor);
                        font-size: ${isMobile ? '15px' : '14px'};
                        cursor: pointer;
                        ${isMobile ? 'width: 100%;' : ''}
                    ">
                        <i class="fa-solid fa-clock"></i> Later
                    </button>
                </div>
            </div>
        `;

        createPopup(content, "420px");

        document.getElementById('flt-pregnancy-yes').addEventListener('click', () => {
            closePopup();
            const pregnancyData = {
                knowledge: 'Hidden',
                week: 1,
                size: BABY_SIZES[1] || 'Poppy seed',
                dueDate: conceptionData.dueDate,
                gender: 'Unknown',
                risks: 'Stable',
                adviceFollowed: 'N/A'
            };
            chatTrackerData['pregnancy'] = pregnancyData;
            saveChatData();
            setTimeout(() => showTrackerModal('pregnancy'), 200);
        });

        document.getElementById('flt-pregnancy-no').addEventListener('click', closePopup);

    }, 500);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MISCARRIAGE SYSTEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function checkForMiscarriage(pregnancyData, previousData = null) {
    if (!extension_settings[extensionName].miscarriageEnabled) return { triggered: false };

    const week = parseInt(pregnancyData.week) || 1;
    const risks = pregnancyData.risks || 'Stable';
    const adviceFollowed = pregnancyData.adviceFollowed || 'N/A';
    const riskDetails = (pregnancyData.riskDetails || '').toLowerCase();

    // Base chance by trimester
    let baseChance = 0;
    if (week <= 12) {
        baseChance = extension_settings[extensionName].miscarriageBaseChance || 3;
    } else if (week <= 20) {
        baseChance = 1;
    } else {
        baseChance = 0.3;
    }

    // Apply risk multiplier
    const riskMultiplier = RISK_MULTIPLIERS[risks] || 1;
    let finalChance = baseChance * riskMultiplier;

    // Increase if advice ignored
    if (adviceFollowed === 'No') {
        finalChance *= 2;
    } else if (adviceFollowed === 'Partially') {
        finalChance *= 1.3;
    }

    // Check for ignored advice keywords
    const hasIgnoredKeywords = IGNORED_ADVICE_KEYWORDS.some(kw => riskDetails.includes(kw));
    if (hasIgnoredKeywords) {
        finalChance *= 1.5;
    }

    // Check if risks worsened from previous
    if (previousData) {
        const prevRiskIndex = Object.keys(RISK_MULTIPLIERS).indexOf(previousData.risks || 'Stable');
        const currRiskIndex = Object.keys(RISK_MULTIPLIERS).indexOf(risks);
        if (currRiskIndex > prevRiskIndex) {
            finalChance *= 1.5; // Risk increased
        }
    }

    // Cap at reasonable maximum
    finalChance = Math.min(finalChance, 40);

    // Roll
    const roll = Math.random() * 100;
    console.log(`FLT: Miscarriage check - Week ${week}, Risk: ${risks}, Advice: ${adviceFollowed}, Chance: ${finalChance.toFixed(1)}%, Roll: ${roll.toFixed(1)}`);

    if (roll < finalChance) {
        // Determine cause
        let cause = 'Unknown/Natural';
        if (adviceFollowed === 'No' || hasIgnoredKeywords) {
            cause = 'Ignored Risks';
        } else if (risks === 'Critical' || risks === 'High Risk') {
            cause = 'Medical Complications';
        }

        return {
            triggered: true,
            cause: cause,
            week: week,
            roll: roll,
            chance: finalChance
        };
    }

    return { triggered: false };
}

function triggerMiscarriageEvent(pregnancyData, miscarriageResult) {
    const isMobile = window.innerWidth <= 768;
    const week = miscarriageResult.week || pregnancyData.week || '??';

    const content = `
        <div style="text-align: center; padding: 20px;">
            <div style="
                font-size: 60px;
                margin-bottom: 20px;
                color: #6c757d;
            ">
                <i class="fa-solid fa-heart-crack"></i>
            </div>

            <div style="
                color: var(--SmartThemeBodyColor);
                font-size: ${isMobile ? '20px' : '18px'};
                font-weight: bold;
                margin-bottom: 10px;
            ">
                Pregnancy Loss
            </div>

            <div style="
                color: var(--SmartThemeBodyColor);
                font-size: ${isMobile ? '14px' : '13px'};
                opacity: 0.8;
                margin-bottom: 20px;
                line-height: 1.5;
            ">
                At week ${week}, the pregnancy has been lost.<br>
                <small style="opacity: 0.7;">Cause: ${miscarriageResult.cause || 'Unknown'}</small>
            </div>

            <div style="
                background: color-mix(in srgb, #6c757d 15%, transparent);
                border: 1px dashed #6c757d;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 20px;
                font-size: 12px;
                color: var(--SmartThemeBodyColor);
                text-align: left;
            ">
                <div style="margin-bottom: 8px;">
                    <i class="fa-solid fa-dice"></i> <strong>Event triggered</strong>
                </div>
                <div style="opacity: 0.8; font-size: 11px;">
                    Roll: ${miscarriageResult.roll?.toFixed(1) || '?'}% / ${miscarriageResult.chance?.toFixed(1) || '?'}% threshold<br>
                    Risk Level: ${pregnancyData.risks || 'Unknown'}<br>
                    Advice Followed: ${pregnancyData.adviceFollowed || 'N/A'}
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: center; ${isMobile ? 'flex-direction: column;' : ''}">
                <button id="flt-miscarriage-proceed" class="menu_button" style="
                    background: #6c757d;
                    color: white;
                    padding: ${isMobile ? '14px 24px' : '12px 24px'};
                    border-radius: 8px;
                    border: none;
                    font-size: ${isMobile ? '15px' : '14px'};
                    cursor: pointer;
                    ${isMobile ? 'width: 100%;' : ''}
                ">
                    <i class="fa-solid fa-file-medical"></i> Fill Loss Report
                </button>
                <button id="flt-miscarriage-skip" class="menu_button" style="
                    background: transparent;
                    color: var(--SmartThemeBodyColor);
                    padding: ${isMobile ? '14px 24px' : '12px 24px'};
                    border-radius: 8px;
                    border: 1px solid var(--SmartThemeBorderColor);
                    font-size: ${isMobile ? '15px' : '14px'};
                    cursor: pointer;
                    ${isMobile ? 'width: 100%;' : ''}
                ">
                    <i class="fa-solid fa-forward"></i> Skip Report
                </button>
                <button id="flt-miscarriage-cancel" class="menu_button" style="
                    background: transparent;
                    color: #e76f51;
                    padding: ${isMobile ? '14px 24px' : '12px 24px'};
                    border-radius: 8px;
                    border: 1px solid #e76f51;
                    font-size: ${isMobile ? '15px' : '14px'};
                    cursor: pointer;
                    ${isMobile ? 'width: 100%;' : ''}
                ">
                    <i class="fa-solid fa-rotate-left"></i> Override (Keep Pregnancy)
                </button>
            </div>
        </div>
    `;

    createPopup(content, "480px");

    document.getElementById('flt-miscarriage-proceed').addEventListener('click', () => {
        closePopup();
        const miscarriageData = {
            weekLost: week,
            cause: miscarriageResult.cause,
            causeDetails: pregnancyData.riskDetails || '',
            emotionalState: 'Grieving'
        };
        chatTrackerData['miscarriage'] = miscarriageData;

        // Clear pregnancy data
        delete chatTrackerData['pregnancy'];
        activeTracker = 'miscarriage';
        saveChatData();

        // Send OOC
        sendTrackerOOC('miscarriage', miscarriageData, pregnancyData);

        setTimeout(() => showTrackerModal('miscarriage'), 200);
    });

    document.getElementById('flt-miscarriage-skip').addEventListener('click', () => {
        closePopup();
        // Clear pregnancy, send OOC but don't fill report
        const miscarriageData = {
            weekLost: week,
            cause: miscarriageResult.cause,
            emotionalState: 'Grieving'
        };
        delete chatTrackerData['pregnancy'];
        chatTrackerData['miscarriage'] = miscarriageData;
        activeTracker = null;
        saveChatData();

        sendTrackerOOC('miscarriage', miscarriageData, pregnancyData);
        showToast('Pregnancy ended. OOC sent to AI.', 'warning');
    });

    document.getElementById('flt-miscarriage-cancel').addEventListener('click', () => {
        closePopup();
        showToast('Miscarriage overridden. Pregnancy continues.', 'success');
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LABOR CHECK SYSTEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function checkForLabor(pregnancyData) {
    if (!extension_settings[extensionName].autoLaborEnabled) return false;
    if (!pregnancyData || !pregnancyData.week) return false;

    const week = parseInt(pregnancyData.week) || 0;
    const risks = (pregnancyData.riskDetails || '').toLowerCase();

    const hasHighRisk = HIGH_RISK_KEYWORDS.some(keyword => risks.includes(keyword));

    let laborChance = 0;

    if (week >= 42) {
        laborChance = 80;
    } else if (week >= 40) {
        laborChance = 50;
    } else if (week >= 37) {
        const weeksOver37 = week - 37;
        laborChance = extension_settings[extensionName].laborChanceBase +
            (weeksOver37 * extension_settings[extensionName].laborChancePerWeek);
    } else if (week >= 34 && hasHighRisk) {
        laborChance = 30;
    } else if (hasHighRisk && week >= 28) {
        laborChance = 15;
    }

    if (laborChance <= 0) return false;

    const roll = Math.random() * 100;
    console.log(`FLT: Labor check - Week ${week}, Chance: ${laborChance}%, Roll: ${roll.toFixed(1)}`);

    return roll < laborChance;
}

function triggerLaborEvent(pregnancyData) {
    const isMobile = window.innerWidth <= 768;
    const week = pregnancyData.week || '??';
    const isPreterm = parseInt(week) < 37;

    // Send labor OOC
    sendTrackerOOC('labor', pregnancyData);

    const content = `
        <div style="text-align: center; padding: 20px;">
            <div style="
                font-size: 60px;
                margin-bottom: 20px;
                animation: flt-pulse 1s infinite;
            ">
                <i class="fa-solid fa-heart-pulse" style="color: #e91e63;"></i>
            </div>

            <div style="
                color: var(--SmartThemeBodyColor);
                font-size: ${isMobile ? '22px' : '20px'};
                font-weight: bold;
                margin-bottom: 10px;
                text-transform: uppercase;
                letter-spacing: 2px;
            ">
                ${isPreterm ? 'âš ï¸ Early Labor!' : 'ğŸ‰ Labor Has Begun!'}
            </div>

            <div style="
                color: var(--SmartThemeBodyColor);
                font-size: ${isMobile ? '14px' : '13px'};
                opacity: 0.8;
                margin-bottom: 20px;
            ">
                At week ${week}, ${isPreterm ? 'contractions have started unexpectedly!' : "it's time!"}
            </div>

            <div style="
                background: color-mix(in srgb, #2a9d8f 15%, transparent);
                border: 1px solid #2a9d8f;
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 20px;
                font-size: 12px;
            ">
                <i class="fa-solid fa-paper-plane" style="color: #2a9d8f;"></i>
                <strong>Labor OOC sent to AI!</strong>
            </div>

            <div style="display: flex; gap: 10px; justify-content: center; ${isMobile ? 'flex-direction: column;' : ''}">
                <button id="flt-labor-proceed" class="menu_button" style="
                    background: #e91e63;
                    color: white;
                    padding: 12px 24px;
                    border-radius: 8px;
                    border: none;
                    cursor: pointer;
                    ${isMobile ? 'width: 100%;' : ''}
                ">
                    <i class="fa-solid fa-baby-carriage"></i> Fill Birth Report
                </button>
                <button id="flt-labor-later" class="menu_button" style="
                    background: transparent;
                    color: var(--SmartThemeBodyColor);
                    padding: 12px 24px;
                    border-radius: 8px;
                    border: 1px solid var(--SmartThemeBorderColor);
                    cursor: pointer;
                    ${isMobile ? 'width: 100%;' : ''}
                ">
                    <i class="fa-solid fa-clock"></i> After Scene
                </button>
            </div>
        </div>

        <style>
            @keyframes flt-pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.1); }
            }
        </style>
    `;

    createPopup(content, "450px");

    document.getElementById('flt-labor-proceed').addEventListener('click', () => {
        closePopup();
        const birthData = {
            gender: pregnancyData.gender || 'Unknown',
            babyName: ''
        };
        chatTrackerData['birth'] = birthData;
        delete chatTrackerData['pregnancy'];
        saveChatData();
        setTimeout(() => showTrackerModal('birth', true), 200);
    });

    document.getElementById('flt-labor-later').addEventListener('click', () => {
        closePopup();
        showToast('Labor OOC sent! Fill Birth Report after the scene.', 'success');
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTO TRANSITION SYSTEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function offerBabyCareTransition(birthData) {
    if (!extension_settings[extensionName].autoTransitionEnabled) return;

    const isMobile = window.innerWidth <= 768;

    setTimeout(() => {
        const content = `
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 50px; margin-bottom: 15px;">ğŸ‘¶âœ¨</div>
                <div style="color: var(--SmartThemeBodyColor); font-size: 16px; font-weight: bold; margin-bottom: 10px;">
                    Congratulations!
                </div>
                <div style="color: var(--SmartThemeBodyColor); font-size: 13px; opacity: 0.8; margin-bottom: 20px;">
                    Set up Baby Care Monitor for ${birthData.babyName || 'the baby'}?
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; ${isMobile ? 'flex-direction: column;' : ''}">
                    <button id="flt-transition-yes" class="menu_button" style="background: #4caf50; color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; ${isMobile ? 'width: 100%;' : ''}">
                        <i class="fa-solid fa-baby"></i> Yes
                    </button>
                    <button id="flt-transition-no" class="menu_button" style="background: transparent; color: var(--SmartThemeBodyColor); padding: 12px 24px; border-radius: 8px; border: 1px solid var(--SmartThemeBorderColor); cursor: pointer; ${isMobile ? 'width: 100%;' : ''}">
                        Later
                    </button>
                </div>
            </div>
        `;

        createPopup(content, "380px");

        document.getElementById('flt-transition-yes').addEventListener('click', () => {
            closePopup();
            const babyCareData = {
                name: birthData.babyName || '',
                age: 'Newborn',
                traits: birthData.temperament || '',
                hunger: 'Full',
                hygiene: 'Clean',
                energy: 'Rested',
                mood: 'Sleeping'
            };
            chatTrackerData['babyCare'] = babyCareData;
            setTimeout(() => showTrackerModal('babyCare'), 200);
        });

        document.getElementById('flt-transition-no').addEventListener('click', closePopup);

    }, 500);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILITY FUNCTIONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function getCurrentChatId() {
    try {
        const context = getContext();
        return context?.chatId?.toString() || 'global';
    } catch (e) {
        return 'global';
    }
}

function loadChatData() {
    try {
        const chatId = getCurrentChatId();
        const saved = localStorage.getItem(`flt_data_${chatId}`);
        if (saved) {
            const parsed = JSON.parse(saved);
            chatTrackerData = parsed.trackers || {};
            activeTracker = parsed.activeTracker || null;
            pregnancyHistory = parsed.pregnancyHistory || [];
        } else {
            chatTrackerData = {};
            activeTracker = null;
            pregnancyHistory = [];
        }
        loadActiveOOC();
    } catch (e) {
        chatTrackerData = {};
        activeTracker = null;
        pregnancyHistory = [];
    }
}

function saveChatData() {
    try {
        const chatId = getCurrentChatId();
        localStorage.setItem(`flt_data_${chatId}`, JSON.stringify({
            trackers: chatTrackerData,
            activeTracker: activeTracker,
            pregnancyHistory: pregnancyHistory
        }));
    } catch (e) { }
}

function saveSettings() {
    localStorage.setItem('flt_settings', JSON.stringify(extension_settings[extensionName]));
}

function loadSettingsFromStorage() {
    try {
        const saved = localStorage.getItem('flt_settings');
        if (saved) {
            extension_settings[extensionName] = { ...defaultSettings, ...JSON.parse(saved) };
        }
    } catch (e) { }
}

function formatDate(dateString) {
    if (!dateString) return '[Date]';
    try {
        const date = new Date(dateString);
        return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getFullYear()).slice(-2)}`;
    } catch (e) {
        return dateString;
    }
}

function showToast(message, type = 'success') {
    const existingToast = document.querySelector('.flt-toast');
    if (existingToast) existingToast.remove();

    const colors = { success: '#2a9d8f', warning: '#f4a261', error: '#e76f51' };
    const icons = { success: 'check-circle', warning: 'exclamation-triangle', error: 'exclamation-circle' };

    const toast = document.createElement('div');
    toast.className = 'flt-toast';
    toast.innerHTML = `<i class="fa-solid fa-${icons[type]}"></i><span>${message}</span>`;
    toast.style.cssText = `position:fixed;bottom:80px;right:20px;background:var(--SmartThemeBlurTintColor);border:1px solid var(--SmartThemeBorderColor);border-radius:8px;padding:12px 20px;z-index:10001;display:flex;align-items:center;gap:10px;box-shadow:0 4px 20px rgba(0,0,0,0.3);color:var(--SmartThemeBodyColor);font-size:13px;border-left:3px solid ${colors[type]};animation:flt-slideIn 0.3s ease;`;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'flt-slideOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POPUP FUNCTIONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function closePopup() {
    const popup = document.getElementById("flt-popup");
    if (popup) popup.remove();
    document.body.style.overflow = '';
    document.body.style.position = '';
    document.body.style.width = '';
}

function createPopup(content, width = "500px") {
    closePopup();

    const isMobile = window.innerWidth <= 768;
    const popup = document.createElement("div");
    popup.id = "flt-popup";
    popup.innerHTML = `
        <div id="flt-popup-bg" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:99998;"></div>
        <div id="flt-popup-content" style="position:fixed;top:${isMobile ? '20px' : '50%'};left:50%;transform:${isMobile ? 'translateX(-50%)' : 'translate(-50%,-50%)'};width:${isMobile ? 'calc(100vw - 40px)' : `min(${width}, 90vw)`};max-height:${isMobile ? 'calc(100vh - 40px)' : '85vh'};background:var(--SmartThemeBlurTintColor);border:1px solid var(--SmartThemeBorderColor);border-radius:12px;padding:20px;z-index:99999;overflow-y:auto;box-shadow:0 10px 30px rgba(0,0,0,0.3);">
            ${content}
        </div>
    `;

    document.body.appendChild(popup);
    document.body.style.overflow = 'hidden';
    if (isMobile) {
        document.body.style.position = 'fixed';
        document.body.style.width = '100%';
    }

    document.getElementById("flt-popup-bg").addEventListener("click", closePopup);
    document.addEventListener('keydown', function closeOnEsc(e) {
        if (e.key === 'Escape') {
            closePopup();
            document.removeEventListener('keydown', closeOnEsc);
        }
    });

    return popup;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS POPUP
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function showSettingsPopup() {
    const s = extension_settings[extensionName];
    const isMobile = window.innerWidth <= 768;

    const toggleHTML = (id, label, desc, setting, color = null) => `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:color-mix(in srgb,var(--SmartThemeBodyColor) 5%,transparent);border-radius:8px;margin-bottom:12px;">
            <div>
                <div style="color:var(--SmartThemeBodyColor);font-size:14px;font-weight:500;">${label}</div>
                <div style="color:var(--SmartThemeBodyColor);font-size:11px;opacity:0.6;">${desc}</div>
            </div>
            <div id="${id}" class="flt-toggle" data-setting="${setting}" style="width:50px;height:26px;background:${s[setting] ? (color || 'var(--SmartThemeAccent)') : 'var(--SmartThemeBorderColor)'};border-radius:13px;cursor:pointer;position:relative;transition:all 0.3s;">
                <div style="position:absolute;top:3px;left:${s[setting] ? '27px' : '3px'};width:20px;height:20px;background:white;border-radius:50%;transition:all 0.3s;"></div>
            </div>
        </div>
    `;

    const content = `
        <div style="color:var(--SmartThemeBodyColor);font-size:16px;font-weight:500;margin-bottom:20px;display:flex;align-items:center;gap:8px;">
            <i class="fa-solid fa-sliders"></i> Life Tracker Settings
        </div>

        ${toggleHTML('flt-toggle-enabled', '<i class="fa-solid fa-power-off"></i> Extension Enabled', 'Show/hide the tracker button', 'enabled')}
        ${toggleHTML('flt-toggle-ooc', '<i class="fa-solid fa-paper-plane"></i> Auto OOC Instructions', 'Send details to AI automatically', 'autoOOCEnabled', '#2a9d8f')}
        ${toggleHTML('flt-toggle-labor', '<i class="fa-solid fa-dice"></i> Auto Labor Events', 'Random labor at 37+ weeks', 'autoLaborEnabled')}
        ${toggleHTML('flt-toggle-miscarriage', '<i class="fa-solid fa-heart-crack"></i> Miscarriage Events', 'Enable pregnancy loss possibility', 'miscarriageEnabled', '#6c757d')}
        ${toggleHTML('flt-toggle-transition', '<i class="fa-solid fa-arrow-right"></i> Auto Transitions', 'Offer next tracker automatically', 'autoTransitionEnabled')}

        <div style="padding:12px;background:color-mix(in srgb,var(--SmartThemeBodyColor) 5%,transparent);border-radius:8px;margin-bottom:12px;">
            <div style="color:var(--SmartThemeBodyColor);font-size:14px;font-weight:500;margin-bottom:12px;">
                <i class="fa-solid fa-percent"></i> Chance Settings
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                <div>
                    <label style="font-size:11px;opacity:0.7;display:block;margin-bottom:4px;">Labor Base % (37wk)</label>
                    <input type="number" id="flt-labor-base" min="0" max="100" value="${s.laborChanceBase}" style="width:100%;padding:8px;background:var(--SmartThemeInputColor);border:1px solid var(--SmartThemeBorderColor);border-radius:6px;color:var(--SmartThemeBodyColor);">
                </div>
                <div>
                    <label style="font-size:11px;opacity:0.7;display:block;margin-bottom:4px;">Labor +% per week</label>
                    <input type="number" id="flt-labor-perweek" min="0" max="50" value="${s.laborChancePerWeek}" style="width:100%;padding:8px;background:var(--SmartThemeInputColor);border:1px solid var(--SmartThemeBorderColor);border-radius:6px;color:var(--SmartThemeBodyColor);">
                </div>
                <div>
                    <label style="font-size:11px;opacity:0.7;display:block;margin-bottom:4px;">Miscarriage Base % (T1)</label>
                    <input type="number" id="flt-miscarriage-base" min="0" max="20" value="${s.miscarriageBaseChance}" style="width:100%;padding:8px;background:var(--SmartThemeInputColor);border:1px solid var(--SmartThemeBorderColor);border-radius:6px;color:var(--SmartThemeBodyColor);">
                </div>
            </div>
        </div>

        ${hasActiveOOC() ? `
        <div style="padding:12px;background:color-mix(in srgb,#2a9d8f 15%,transparent);border:1px solid #2a9d8f;border-radius:8px;margin-bottom:12px;">
            <div style="color:#2a9d8f;font-size:14px;font-weight:500;margin-bottom:8px;">
                <i class="fa-solid fa-paper-plane"></i> Active OOC: ${TRACKERS[activeOOC?.trackerId]?.name || 'Unknown'}
            </div>
            <button id="flt-clear-ooc" style="background:transparent;color:#2a9d8f;padding:6px 12px;border-radius:6px;border:1px solid #2a9d8f;font-size:12px;cursor:pointer;">
                <i class="fa-solid fa-eraser"></i> Clear OOC
            </button>
        </div>
        ` : ''}

        <div style="padding:12px;background:color-mix(in srgb,#e76f51 10%,transparent);border:1px solid #e76f51;border-radius:8px;margin-bottom:20px;">
            <div style="color:#e76f51;font-size:14px;font-weight:500;margin-bottom:8px;">
                <i class="fa-solid fa-trash"></i> Clear All Data
            </div>
            <button id="flt-clear-data" style="background:#e76f51;color:white;padding:8px 16px;border-radius:6px;border:none;font-size:12px;cursor:pointer;">
                <i class="fa-solid fa-eraser"></i> Clear
            </button>
        </div>

        <div style="display:flex;gap:10px;justify-content:center;">
            <button id="flt-settings-save" class="menu_button" style="background:var(--SmartThemeButtonColor);color:var(--SmartThemeButtonTextColor);padding:12px 24px;border-radius:8px;border:none;cursor:pointer;">
                <i class="fa-solid fa-save"></i> Save
            </button>
            <button id="flt-settings-close" class="menu_button" style="background:transparent;color:var(--SmartThemeBodyColor);padding:12px 24px;border-radius:8px;border:1px solid var(--SmartThemeBorderColor);cursor:pointer;">
                <i class="fa-solid fa-xmark"></i> Close
            </button>
        </div>
    `;

    createPopup(content, "480px");

    // Toggle handlers
    document.querySelectorAll('.flt-toggle').forEach(toggle => {
        toggle.addEventListener('click', function () {
            const setting = this.dataset.setting;
            const isActive = !extension_settings[extensionName][setting];
            extension_settings[extensionName][setting] = isActive;
            this.style.background = isActive ? (this.id.includes('ooc') ? '#2a9d8f' : this.id.includes('miscarriage') ? '#6c757d' : 'var(--SmartThemeAccent)') : 'var(--SmartThemeBorderColor)';
            this.querySelector('div').style.left = isActive ? '27px' : '3px';
            if (setting === 'enabled') updateButtonVisibility();
        });
    });

    const clearOocBtn = document.getElementById('flt-clear-ooc');
    if (clearOocBtn) {
        clearOocBtn.addEventListener('click', () => {
            clearTrackerOOC();
            showToast('OOC cleared', 'success');
            closePopup();
            showSettingsPopup();
        });
    }

    document.getElementById('flt-clear-data').addEventListener('click', () => {
        if (confirm('Clear all tracker data for this chat?')) {
            chatTrackerData = {};
            activeTracker = null;
            pregnancyHistory = [];
            saveChatData();
            clearTrackerOOC();
            showToast('Data cleared', 'success');
            updateMenuState();
        }
    });

    document.getElementById('flt-settings-save').addEventListener('click', () => {
        extension_settings[extensionName].laborChanceBase = parseInt(document.getElementById('flt-labor-base').value) || 15;
        extension_settings[extensionName].laborChancePerWeek = parseInt(document.getElementById('flt-labor-perweek').value) || 10;
        extension_settings[extensionName].miscarriageBaseChance = parseInt(document.getElementById('flt-miscarriage-base').value) || 3;
        saveSettings();
        showToast('Settings saved!', 'success');
        closePopup();
    });

    document.getElementById('flt-settings-close').addEventListener('click', closePopup);

    const menu = document.getElementById("flt-menu");
    if (menu) menu.style.display = "none";
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TRACKER HTML GENERATORS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function generateTrackerHTML(trackerId, data) {
    switch (trackerId) {
        case 'conception': return generateConceptionHTML(data);
        case 'pregnancy': return generatePregnancyHTML(data);
        case 'birth': return generateBirthHTML(data);
        case 'babyCare': return generateBabyCareHTML(data);
        case 'miscarriage': return generateMiscarriageHTML(data);
        default: return '<p>Unknown tracker</p>';
    }
}

function generateConceptionHTML(data) {
    const roll = data.roll || '[Roll]';
    const threshold = data.threshold || 20;
    const conception = data.conception || 'Pending';
    const resultColor = conception === 'Yes' ? '#4caf50' : conception === 'No' ? '#e76f51' : 'var(--SmartThemeQuoteColor)';
    const dueDate = data.dueDate ? formatDate(data.dueDate) : '[Calculating...]';

    return `<div style="background:transparent;color:var(--SmartThemeBodyColor);font-family:'Courier New',monospace;font-size:0.85em;padding:8px;margin:10px 0;text-align:center;letter-spacing:1px;border:1px dashed var(--SmartThemeBorderColor);border-radius:6px;">
    <div style="margin-bottom:8px;opacity:0.8;"><i class="fa-solid fa-dice"></i> CONCEPTION ROLL</div>
    <div style="font-size:1.2em;margin-bottom:8px;">
        <span style="color:var(--SmartThemeAccent);font-weight:bold;">${roll}</span>
        <span style="opacity:0.5;"> / ${threshold} threshold</span>
    </div>
    <div style="font-size:1.1em;font-weight:bold;color:${resultColor};">
        ${conception === 'Yes' ? 'âœ“ CONCEIVED' : conception === 'No' ? 'âœ— NOT CONCEIVED' : 'â³ PENDING'}
    </div>
    ${conception === 'Yes' ? `<div style="margin-top:8px;font-size:0.9em;opacity:0.8;"><i class="fa-regular fa-calendar"></i> Due: ${dueDate}</div>` : ''}
</div>`;
}

function generatePregnancyHTML(data) {
    const week = data.week || '[Week]';
    const size = data.size || BABY_SIZES[parseInt(week)] || '[Size]';
    const riskColors = { 'Stable': '#4caf50', 'Mild Concern': '#f4a261', 'Moderate Risk': '#e76f51', 'High Risk': '#dc3545', 'Critical': '#6c757d' };
    const riskColor = riskColors[data.risks] || '#4caf50';

    return `<div style="background:color-mix(in srgb,var(--SmartThemeBodyColor) 5%,transparent);border:1px solid var(--SmartThemeBorderColor);border-radius:6px;padding:10px;margin:10px 0;font-family:'Courier New',monospace;font-size:0.85em;color:var(--SmartThemeBodyColor);">
    <div style="border-bottom:1px dashed var(--SmartThemeBorderColor);margin-bottom:8px;padding-bottom:4px;font-weight:bold;color:var(--SmartThemeAccent);text-transform:uppercase;letter-spacing:1px;">
        <i class="fa-solid fa-person-pregnant"></i> Pregnancy Status
    </div>
    <div style="font-size:0.75em;margin-bottom:8px;color:var(--SmartThemeAccent);opacity:0.8;">
        <i class="fa-solid fa-${data.knowledge === 'Hidden' ? 'eye-slash' : data.knowledge === 'Suspected' ? 'question' : 'eye'}"></i> ${data.knowledge || 'Hidden'}
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;">
        <div><span style="opacity:0.7;"><i class="fa-regular fa-clock"></i> Week:</span> <strong style="color:var(--SmartThemeQuoteColor);">${week}</strong></div>
        <div><span style="opacity:0.7;"><i class="fa-solid fa-apple-whole"></i> Size:</span> <strong style="color:var(--SmartThemeQuoteColor);">${size}</strong></div>
        <div><span style="opacity:0.7;"><i class="fa-regular fa-calendar"></i> Due:</span> <strong style="color:var(--SmartThemeQuoteColor);">${data.dueDate ? formatDate(data.dueDate) : '[Date]'}</strong></div>
        <div><span style="opacity:0.7;"><i class="fa-solid fa-venus-mars"></i> Gender:</span> <strong style="color:var(--SmartThemeQuoteColor);">${data.gender || 'Unknown'}</strong></div>
    </div>
    <div style="margin-top:8px;border-top:1px dotted var(--SmartThemeBorderColor);padding-top:5px;">
        ${data.symptoms ? `<div style="margin-bottom:4px;"><span style="color:var(--SmartThemeAccent);"><i class="fa-solid fa-head-side-virus"></i> Symptoms:</span> ${data.symptoms}</div>` : ''}
        <div style="margin-bottom:4px;background:color-mix(in srgb,${riskColor} 15%,transparent);padding:4px 8px;border-radius:4px;border-left:3px solid ${riskColor};">
            <span style="color:${riskColor};font-weight:bold;"><i class="fa-solid fa-triangle-exclamation"></i> Risk: ${data.risks || 'Stable'}</span>
            ${data.riskDetails ? `<div style="font-size:0.9em;opacity:0.8;margin-top:2px;">${data.riskDetails}</div>` : ''}
        </div>
        ${data.doctorAdvice ? `<div style="margin-top:4px;font-size:0.9em;"><i class="fa-solid fa-user-doctor"></i> Advice: ${data.doctorAdvice} <span style="opacity:0.7;">(${data.adviceFollowed || 'N/A'})</span></div>` : ''}
    </div>
</div>`;
}

function generateBirthHTML(data) {
    return `<div style="background:color-mix(in srgb,var(--SmartThemeBodyColor) 5%,transparent);border:1px solid var(--SmartThemeBorderColor);border-radius:8px;padding:12px;margin:10px 0;font-family:'Courier New',monospace;font-size:0.85em;color:var(--SmartThemeBodyColor);border-left:4px solid var(--SmartThemeAccent);">
    <div style="border-bottom:1px dashed var(--SmartThemeBorderColor);margin-bottom:8px;padding-bottom:4px;font-weight:bold;color:var(--SmartThemeAccent);text-transform:uppercase;">
        <i class="fa-solid fa-baby-carriage"></i> Birth Report ${data.babyName ? '- ' + data.babyName : ''}
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <div><span style="opacity:0.7;"><i class="fa-solid fa-venus-mars"></i></span> <strong>${data.gender || '[Gender]'}</strong></div>
        <div><span style="opacity:0.7;"><i class="fa-solid fa-weight-scale"></i></span> <strong>${data.weight ? data.weight + ' kg' : '[Weight]'}</strong></div>
        <div><span style="opacity:0.7;"><i class="fa-solid fa-ruler-vertical"></i></span> <strong>${data.height ? data.height + ' cm' : '[Height]'}</strong></div>
        <div><span style="opacity:0.7;"><i class="fa-solid fa-heart-pulse"></i></span> <strong>${data.health || 'Stable'}</strong></div>
    </div>
    ${data.features ? `<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--SmartThemeBorderColor);"><i class="fa-solid fa-dna"></i> ${data.features}</div>` : ''}
    ${data.temperament ? `<div style="margin-top:4px;opacity:0.8;"><i class="fa-solid fa-brain"></i> ${data.temperament}</div>` : ''}
</div>`;
}

function generateBabyCareHTML(data) {
    const moodEmoji = { 'Happy': 'ğŸ˜Š', 'Content': 'ğŸ˜Œ', 'Fussy': 'ğŸ˜£', 'Crying': 'ğŸ˜­', 'Sleeping': 'ğŸ˜´' };
    return `<div style="background:color-mix(in srgb,var(--SmartThemeBodyColor) 5%,transparent);border:1px solid var(--SmartThemeBorderColor);border-radius:6px;padding:10px;margin:10px 0;font-family:'Courier New',monospace;font-size:0.85em;color:var(--SmartThemeBodyColor);">
    <div style="border-bottom:1px dashed var(--SmartThemeBorderColor);margin-bottom:8px;padding-bottom:4px;font-weight:bold;color:var(--SmartThemeAccent);text-transform:uppercase;">
        <i class="fa-solid fa-baby"></i> Baby Care - ${data.name || '[Name]'}
    </div>
    <div style="font-size:0.75em;margin-bottom:8px;opacity:0.8;">Age: ${data.age || 'Newborn'}</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;">
        <div><i class="fa-solid fa-utensils"></i> ${data.hunger || 'Full'}</div>
        <div><i class="fa-solid fa-soap"></i> ${data.hygiene || 'Clean'}</div>
        <div><i class="fa-solid fa-bed"></i> ${data.energy || 'Rested'}</div>
        <div>${moodEmoji[data.mood] || 'ğŸ˜Œ'} ${data.mood || 'Content'}</div>
    </div>
    ${data.immediateNeed && data.immediateNeed !== 'None' ? `<div style="margin-top:8px;background:rgba(231,111,81,0.15);padding:6px;border-radius:4px;color:#e76f51;"><i class="fa-solid fa-exclamation-circle"></i> ${data.immediateNeed}</div>` : ''}
</div>`;
}

function generateMiscarriageHTML(data) {
    return `<div style="background:color-mix(in srgb,#6c757d 10%,transparent);border:1px solid #6c757d;border-radius:6px;padding:10px;margin:10px 0;font-family:'Courier New',monospace;font-size:0.85em;color:var(--SmartThemeBodyColor);">
    <div style="border-bottom:1px dashed #6c757d;margin-bottom:8px;padding-bottom:4px;font-weight:bold;color:#6c757d;text-transform:uppercase;">
        <i class="fa-solid fa-heart-crack"></i> Loss Report
    </div>
    <div style="opacity:0.9;">
        <div style="margin-bottom:4px;"><strong>Week:</strong> ${data.weekLost || '[Week]'}</div>
        <div style="margin-bottom:4px;"><strong>Cause:</strong> ${data.cause || 'Unknown'}</div>
        ${data.causeDetails ? `<div style="margin-bottom:4px;opacity:0.8;font-size:0.9em;">${data.causeDetails}</div>` : ''}
        <div style="margin-bottom:4px;"><strong>Emotional State:</strong> ${data.emotionalState || 'Grieving'}</div>
        ${data.support ? `<div><strong>Support:</strong> ${data.support}</div>` : ''}
    </div>
</div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORM GENERATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function generateFieldHTML(field, value, isMobile) {
    const currentValue = value !== undefined ? value : field.default || '';
    const padding = isMobile ? '14px' : '10px';
    const fontSize = isMobile ? '14px' : '13px';

    let inputHTML = '';
    const baseStyle = `width:100%;padding:${padding};background:var(--SmartThemeInputColor);border:1px solid var(--SmartThemeBorderColor);border-radius:8px;color:var(--SmartThemeBodyColor);font-size:${fontSize};font-family:monospace;`;

    switch (field.type) {
        case 'select':
            inputHTML = `<select id="flt-field-${field.id}" name="${field.id}" style="${baseStyle}">${field.options.map(opt => `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${opt}</option>`).join('')}</select>`;
            break;
        case 'textarea':
            inputHTML = `<textarea id="flt-field-${field.id}" name="${field.id}" style="${baseStyle}height:${isMobile ? '80px' : '60px'};resize:vertical;" placeholder="Enter ${field.label.toLowerCase()}...">${currentValue}</textarea>`;
            break;
        case 'number':
            inputHTML = `<input type="number" id="flt-field-${field.id}" name="${field.id}" value="${currentValue}" ${field.min !== undefined ? `min="${field.min}"` : ''} ${field.max !== undefined ? `max="${field.max}"` : ''} placeholder="${field.label}" style="${baseStyle}">`;
            break;
        case 'date':
            inputHTML = `<input type="date" id="flt-field-${field.id}" name="${field.id}" value="${currentValue}" style="${baseStyle}">`;
            break;
        default:
            inputHTML = `<input type="text" id="flt-field-${field.id}" name="${field.id}" value="${currentValue}" placeholder="Enter ${field.label.toLowerCase()}..." style="${baseStyle}">`;
    }

    return `<div style="margin-bottom:${isMobile ? '16px' : '12px'};"><label style="display:block;font-size:${isMobile ? '13px' : '12px'};color:var(--SmartThemeBodyColor);margin-bottom:6px;opacity:0.8;">${field.label}</label>${inputHTML}</div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TRACKER MODAL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function showTrackerModal(trackerId, isFromLabor = false) {
    const tracker = TRACKERS[trackerId];
    if (!tracker) return;

    const isMobile = window.innerWidth <= 768;
    const savedData = chatTrackerData[trackerId] || {};

    // Auto-fill baby size for pregnancy
    if (trackerId === 'pregnancy' && savedData.week && !savedData.size) {
        savedData.size = BABY_SIZES[parseInt(savedData.week)] || '';
    }

    const fieldsHTML = tracker.fields.map(field => generateFieldHTML(field, savedData[field.id], isMobile)).join('');
    const otherTrackers = Object.values(TRACKERS).filter(t => t.id !== trackerId).map(t => `<option value="${t.id}">${t.name}</option>`).join('');

    // Special buttons for conception
    const specialButtons = trackerId === 'conception' ? `
        <button id="flt-btn-roll" class="menu_button" style="background:#9b59b6;color:white;padding:${isMobile ? '14px 20px' : '10px 16px'};border-radius:6px;border:none;cursor:pointer;display:flex;align-items:center;gap:6px;${isMobile ? 'width:100%;' : 'flex:1;'}justify-content:center;">
            <i class="fa-solid fa-dice"></i> Roll!
        </button>
    ` : '';

    const content = `
        <div style="color:var(--SmartThemeBodyColor);font-size:16px;font-weight:500;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;">
            <div style="display:flex;align-items:center;gap:8px;">
                <i class="${tracker.icon}" style="color:${tracker.color};"></i> ${tracker.name}
            </div>
            <select id="flt-switch-tracker" style="padding:6px 10px;background:var(--SmartThemeInputColor);border:1px solid var(--SmartThemeBorderColor);border-radius:6px;color:var(--SmartThemeBodyColor);font-size:12px;">
                <option value="">Switch to...</option>
                ${otherTrackers}
            </select>
        </div>

        ${isFromLabor ? `<div style="background:color-mix(in srgb,#e91e63 15%,transparent);border:1px solid #e91e63;border-radius:8px;padding:12px;margin-bottom:16px;font-size:12px;"><i class="fa-solid fa-heart-pulse"></i> <strong>Labor in progress!</strong></div>` : ''}

        <form id="flt-tracker-form" data-tracker="${trackerId}">${fieldsHTML}</form>

        <div style="background:color-mix(in srgb,var(--SmartThemeBodyColor) 3%,transparent);border:1px dashed var(--SmartThemeBorderColor);border-radius:8px;padding:15px;margin:16px 0;">
            <div style="font-size:11px;text-transform:uppercase;color:var(--SmartThemeAccent);margin-bottom:10px;"><i class="fa-solid fa-eye"></i> Preview</div>
            <div id="flt-preview-content">${generateTrackerHTML(trackerId, savedData)}</div>
        </div>

        <div style="display:flex;gap:8px;justify-content:center;${isMobile ? 'flex-direction:column;' : 'flex-wrap:wrap;'}">
            ${specialButtons}
            <button id="flt-btn-apply" class="menu_button" style="background:var(--SmartThemeButtonColor);color:var(--SmartThemeButtonTextColor);padding:${isMobile ? '14px 20px' : '10px 16px'};border-radius:6px;border:none;cursor:pointer;display:flex;align-items:center;gap:6px;${isMobile ? 'width:100%;' : 'flex:1;'}justify-content:center;">
                <i class="fa-solid fa-check"></i> Apply
            </button>
            <button id="flt-btn-ai" class="menu_button" style="background:color-mix(in srgb,#2a9d8f 20%,transparent);color:#2a9d8f;padding:${isMobile ? '14px 20px' : '10px 16px'};border-radius:6px;border:1px solid #2a9d8f;cursor:pointer;display:flex;align-items:center;gap:6px;${isMobile ? 'width:100%;' : 'flex:1;'}justify-content:center;">
                <i class="fa-solid fa-wand-magic-sparkles"></i> Let AI Fill
            </button>
            <button id="flt-btn-cancel" class="menu_button" style="background:transparent;color:var(--SmartThemeBodyColor);padding:${isMobile ? '14px 20px' : '10px 16px'};border-radius:6px;border:1px solid var(--SmartThemeBorderColor);cursor:pointer;display:flex;align-items:center;gap:6px;${isMobile ? 'width:100%;' : 'flex:1;'}justify-content:center;">
                <i class="fa-solid fa-xmark"></i> Cancel
            </button>
        </div>
    `;

    createPopup(content, "580px");

    // Switch tracker
    document.getElementById('flt-switch-tracker').addEventListener('change', function () {
        if (this.value) {
            closePopup();
            setTimeout(() => showTrackerModal(this.value), 200);
        }
    });

    // Live preview
    const form = document.getElementById('flt-tracker-form');
    form.querySelectorAll('input, select, textarea').forEach(input => {
        input.addEventListener('input', () => updatePreview(trackerId));
        input.addEventListener('change', () => updatePreview(trackerId));
    });

    // Auto-update baby size when week changes
    if (trackerId === 'pregnancy') {
        const weekInput = document.getElementById('flt-field-week');
        const sizeInput = document.getElementById('flt-field-size');
        if (weekInput && sizeInput) {
            weekInput.addEventListener('change', () => {
                const week = parseInt(weekInput.value);
                if (BABY_SIZES[week] && !sizeInput.value) {
                    sizeInput.value = BABY_SIZES[week];
                    updatePreview(trackerId);
                }
            });
        }
    }

    // Roll button for conception
    const rollBtn = document.getElementById('flt-btn-roll');
    if (rollBtn) {
        rollBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const thresholdInput = document.getElementById('flt-field-threshold');
            const rollInput = document.getElementById('flt-field-roll');
            const conceptionSelect = document.getElementById('flt-field-conception');
            const dueDateInput = document.getElementById('flt-field-dueDate');
            const conceptionDateInput = document.getElementById('flt-field-conceptionDate');

            const threshold = parseInt(thresholdInput?.value) || 20;
            const result = rollConception(threshold);

            if (rollInput) rollInput.value = result.roll;
            if (conceptionSelect) conceptionSelect.value = result.success ? 'Yes' : 'No';

            if (result.success) {
                const today = new Date().toISOString().split('T')[0];
                if (conceptionDateInput) conceptionDateInput.value = today;
                if (dueDateInput) dueDateInput.value = calculateDueDate(today);
            }

            updatePreview(trackerId);
            showToast(`Rolled ${result.roll}! ${result.success ? 'ğŸ‰ Conception!' : 'Not this time.'}`, result.success ? 'success' : 'warning');
        });
    }

    // Apply button
    document.getElementById('flt-btn-apply').addEventListener('click', () => applyTracker(trackerId, false));
    document.getElementById('flt-btn-ai').addEventListener('click', () => applyTracker(trackerId, true));
    document.getElementById('flt-btn-cancel').addEventListener('click', closePopup);

    const menu = document.getElementById("flt-menu");
    if (menu) menu.style.display = "none";
}

function updatePreview(trackerId) {
    const form = document.getElementById('flt-tracker-form');
    const formData = new FormData(form);
    const data = {};
    for (const [key, value] of formData.entries()) {
        data[key] = value;
    }
    const preview = document.getElementById('flt-preview-content');
    if (preview) {
        preview.innerHTML = generateTrackerHTML(trackerId, data);
    }
}

function applyTracker(trackerId, letAiFill = false) {
    const form = document.getElementById('flt-tracker-form');
    const formData = new FormData(form);
    const data = {};

    for (const [key, value] of formData.entries()) {
        data[key] = letAiFill ? '' : value;
    }

    // Get previous data for comparison
    const previousData = chatTrackerData[trackerId] ? { ...chatTrackerData[trackerId] } : null;

    // Save data
    if (!letAiFill) {
        chatTrackerData[trackerId] = data;

        // Track pregnancy history for risk progression
        if (trackerId === 'pregnancy') {
            pregnancyHistory.push({
                week: data.week,
                risks: data.risks,
                adviceFollowed: data.adviceFollowed,
                timestamp: Date.now()
            });
            if (pregnancyHistory.length > 50) pregnancyHistory.shift();
        }
    }

    activeTracker = trackerId;
    saveChatData();

    // CONCEPTION: Check for success and offer pregnancy transition
    if (trackerId === 'conception' && !letAiFill && data.conception === 'Yes') {
        sendTrackerOOC('conception', data);

        // Insert HTML
        insertTrackerHTML(trackerId, data);
        closePopup();

        // Offer pregnancy transition
        offerPregnancyTransition(data);
        return;
    }

    // PREGNANCY: Check for miscarriage first, then labor
    if (trackerId === 'pregnancy' && !letAiFill) {
        // Check miscarriage
        const miscarriageResult = checkForMiscarriage(data, previousData);
        if (miscarriageResult.triggered) {
            closePopup();
            setTimeout(() => triggerMiscarriageEvent(data, miscarriageResult), 300);
            return;
        }

        // Check labor
        if (checkForLabor(data)) {
            closePopup();
            setTimeout(() => triggerLaborEvent(data), 300);
            return;
        }

        // Normal pregnancy update - send OOC
        sendTrackerOOC('pregnancy', data);
    }

    // BIRTH: Send OOC and offer baby care
    if (trackerId === 'birth' && !letAiFill) {
        sendTrackerOOC('birth', data);
        delete chatTrackerData['pregnancy']; // Clear pregnancy
        saveChatData();
    }

    // BABY CARE: Send OOC
    if (trackerId === 'babyCare' && !letAiFill) {
        sendTrackerOOC('babyCare', data);
    }

    // Insert HTML
    insertTrackerHTML(trackerId, data);
    closePopup();

    const oocNote = (!letAiFill && ['conception', 'pregnancy', 'birth', 'babyCare', 'miscarriage'].includes(trackerId) && extension_settings[extensionName].autoOOCEnabled) ? ' + OOC!' : '';
    showToast(`${TRACKERS[trackerId].name} ${letAiFill ? 'template' : ''} inserted!${oocNote}`, 'success');

    // Offer baby care after birth
    if (trackerId === 'birth' && !letAiFill) {
        offerBabyCareTransition(data);
    }
}

function insertTrackerHTML(trackerId, data) {
    const html = generateTrackerHTML(trackerId, data);
    const textarea = document.getElementById('send_textarea');

    if (textarea) {
        undoHistory.push({
            trackerId: trackerId,
            previousContent: textarea.value,
            timestamp: Date.now()
        });
        if (undoHistory.length > 10) undoHistory.shift();

        const currentText = textarea.value;
        textarea.value = currentText + (currentText ? '\n\n' : '') + html;
        textarea.dispatchEvent(new Event('input', { bubbles: true }));
        updateMenuState();
    }
}

function undoLastInsert() {
    if (undoHistory.length === 0) {
        showToast('Nothing to undo', 'error');
        return;
    }

    const lastAction = undoHistory.pop();
    const textarea = document.getElementById('send_textarea');

    if (textarea) {
        textarea.value = lastAction.previousContent;
        textarea.dispatchEvent(new Event('input', { bubbles: true }));
    }

    updateMenuState();
    showToast('Undone!', 'success');

    const menu = document.getElementById("flt-menu");
    if (menu) menu.style.display = "none";
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MENU STATE & VISIBILITY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function updateButtonVisibility() {
    const btn = document.getElementById("flt-btn");
    if (btn) {
        btn.style.display = extension_settings[extensionName].enabled ? 'inline-flex' : 'none';
    }
}

function updateMenuState() {
    const undoOption = document.getElementById("flt-undo-option");
    if (undoOption) {
        undoOption.style.display = undoHistory.length > 0 ? "flex" : "none";
    }

    const clearOocOption = document.getElementById("flt-clear-ooc-option");
    if (clearOocOption) {
        clearOocOption.style.display = hasActiveOOC() ? "flex" : "none";
    }

    // Update indicators
    Object.keys(TRACKERS).forEach(trackerId => {
        const item = document.querySelector(`[data-tracker="${trackerId}"]`);
        if (item) {
            const activeInd = item.querySelector('.flt-active-indicator');
            const dataInd = item.querySelector('.flt-data-indicator');
            if (activeInd) activeInd.style.display = activeTracker === trackerId ? 'inline' : 'none';
            if (dataInd) dataInd.style.display = chatTrackerData[trackerId] ? 'inline' : 'none';
        }
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN BUTTON AND MENU
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function addFLTMenu() {
    if (document.getElementById("flt-btn")) return true;

    const container = document.getElementById("leftSendForm") || document.getElementById("form_sheld") || document.querySelector("#send_form");
    if (!container) return false;

    const btn = document.createElement("div");
    btn.id = "flt-btn";
    btn.title = "Fawn's Life Tracker";
    btn.innerHTML = '<i class="fa-solid fa-heart-pulse"></i>';
    btn.style.cssText = `cursor:pointer;display:${extension_settings[extensionName].enabled ? 'inline-flex' : 'none'};align-items:center;justify-content:center;width:32px;height:32px;color:var(--SmartThemeBodyColor);font-size:14px;margin:0 2px;border-radius:5px;transition:all 0.2s;opacity:0.8;`;

    btn.addEventListener("mouseenter", function () { this.style.background = "var(--SmartThemeBorderColor)"; this.style.opacity = "1"; });
    btn.addEventListener("mouseleave", function () { this.style.background = ""; this.style.opacity = "0.8"; });

    const menu = document.createElement("div");
    menu.id = "flt-menu";
    menu.style.cssText = `display:none;position:absolute;bottom:calc(100% + 5px);left:0;background:var(--SmartThemeBlurTintColor);backdrop-filter:blur(10px);border:1px solid var(--SmartThemeBorderColor);border-radius:8px;padding:8px;z-index:1001;min-width:280px;box-shadow:0 4px 12px rgba(0,0,0,0.2);max-height:500px;overflow-y:auto;`;

    const trackerOptionsHTML = Object.values(TRACKERS).map(tracker => `
        <div class="flt-option" data-action="tracker" data-tracker="${tracker.id}" style="padding:12px;cursor:pointer;color:var(--SmartThemeBodyColor);border-radius:6px;margin:4px 0;display:flex;align-items:center;gap:12px;font-size:13px;">
            <div style="width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:color-mix(in srgb,${tracker.color} 20%,transparent);border-radius:50%;color:${tracker.color};">
                <i class="${tracker.icon}"></i>
            </div>
            <div style="flex:1;">
                <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
                    <span>${tracker.name}</span>
                    <span class="flt-active-indicator" style="font-size:9px;padding:2px 6px;background:var(--SmartThemeAccent);color:white;border-radius:10px;display:none;">ACTIVE</span>
                    <span class="flt-data-indicator" style="font-size:9px;padding:2px 6px;background:${tracker.color};color:white;border-radius:10px;display:none;">DATA</span>
                </div>
                <div style="font-size:10px;opacity:0.6;">${tracker.description}</div>
            </div>
        </div>
    `).join('');

    menu.innerHTML = `
        <div style="padding:8px 12px;color:var(--SmartThemeAccent);font-size:11px;text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid var(--SmartThemeBorderColor);margin-bottom:6px;">
            <i class="fa-solid fa-heart-pulse"></i> Life Tracker
            ${hasActiveOOC() ? '<span style="margin-left:auto;font-size:9px;padding:2px 6px;background:#2a9d8f;color:white;border-radius:10px;float:right;">OOC</span>' : ''}
        </div>
        ${trackerOptionsHTML}
        <hr style="border:none;border-top:1px solid var(--SmartThemeBorderColor);margin:8px 0;">
        <div id="flt-undo-option" class="flt-option" data-action="undo" style="padding:10px 12px;cursor:pointer;color:#f4a261;border-radius:6px;display:none;align-items:center;gap:10px;">
            <i class="fa-solid fa-rotate-left"></i> Undo
        </div>
        <div id="flt-clear-ooc-option" class="flt-option" data-action="clearooc" style="padding:10px 12px;cursor:pointer;color:#2a9d8f;border-radius:6px;display:none;align-items:center;gap:10px;">
            <i class="fa-solid fa-paper-plane"></i> Clear OOC
        </div>
        <div class="flt-option" data-action="settings" style="padding:10px 12px;cursor:pointer;color:var(--SmartThemeBodyColor);border-radius:6px;display:flex;align-items:center;gap:10px;opacity:0.8;">
            <i class="fa-solid fa-sliders"></i> Settings
        </div>
    `;

    container.insertBefore(btn, container.firstChild);
    document.body.appendChild(menu);

    btn.addEventListener("click", function (e) {
        e.preventDefault();
        e.stopPropagation();
        closePopup();
        updateMenuState();

        const btnRect = btn.getBoundingClientRect();
        menu.style.left = btnRect.left + "px";
        menu.style.bottom = (window.innerHeight - btnRect.top + 5) + "px";
        menu.style.display = menu.style.display === "block" ? "none" : "block";
    });

    menu.querySelectorAll(".flt-option").forEach(opt => {
        opt.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            const action = this.dataset.action;

            if (action === "tracker") {
                menu.style.display = "none";
                showTrackerModal(this.dataset.tracker);
            } else if (action === "undo") {
                undoLastInsert();
            } else if (action === "clearooc") {
                clearTrackerOOC();
                showToast('OOC cleared', 'success');
                menu.style.display = "none";
            } else if (action === "settings") {
                showSettingsPopup();
            }
        });

        opt.addEventListener("mouseenter", function () {
            this.style.background = "color-mix(in srgb, var(--SmartThemeAccent) 15%, transparent)";
        });
        opt.addEventListener("mouseleave", function () {
            this.style.background = "";
        });
    });

    document.addEventListener("click", (e) => {
        if (!btn.contains(e.target) && !menu.contains(e.target)) menu.style.display = "none";
    });

    window.addEventListener("scroll", () => menu.style.display = "none");
    window.addEventListener("resize", () => menu.style.display = "none");

    console.log("FLT: Menu created");
    return true;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EVENTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

eventSource.on(event_types.MESSAGE_RECEIVED, () => {
    if (hasActiveOOC()) {
        console.log('FLT: Message received, clearing OOC');
        clearTrackerOOC();
    }
});

eventSource.on(event_types.MESSAGE_SWIPED, () => {
    if (activeOOC?.trackerId) {
        console.log('FLT: Swiped, re-sending OOC');
        sendTrackerOOC(activeOOC.trackerId, activeOOC.data);
    }
});

eventSource.on(event_types.CHAT_CHANGED, () => {
    loadChatData();
    undoHistory = [];
    setTimeout(updateMenuState, 300);
});

eventSource.on(event_types.CHAT_LOADED, () => {
    loadChatData();
    setTimeout(updateMenuState, 500);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INITIALIZATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

jQuery(() => {
    loadSettingsFromStorage();
    loadChatData();

    setTimeout(() => {
        if (!document.getElementById("flt-btn")) addFLTMenu();
        setTimeout(updateMenuState, 200);
    }, 800);

    setTimeout(() => {
        if (!document.getElementById("flt-btn")) addFLTMenu();
        updateMenuState();
    }, 2500);

    const style = document.createElement('style');
    style.textContent = `
        @keyframes flt-slideIn { from { opacity:0;transform:translateX(100px); } to { opacity:1;transform:translateX(0); } }
        @keyframes flt-slideOut { from { opacity:1;transform:translateX(0); } to { opacity:0;transform:translateX(100px); } }
    `;
    document.head.appendChild(style);

    console.log("Fawn's Life Tracker v3.0: Ready!");
});
